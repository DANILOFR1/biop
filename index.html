<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioPlan</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4285f4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="BioPlan">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <!-- SheetJS para exportação em Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js para visualizações gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Registrar o Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar o Service Worker:', error);
                    });
            });
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            padding: 0;
            background-color: #f5f5f5;
            line-height: 1.6;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .card-collapsible {
            margin-bottom: 10px;
        }
        .card-content {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            margin-top: -5px;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }
        .card-header:hover {
            background-color: #f0f7ff;
            border-color: #4285f4;
        }
        .card-header h3 {
            margin: 0;
            font-size: 18px;
            color: #1a73e8;
        }
        .section-title {
            font-size: 20px;
            color: #1a73e8;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4285f4;
            font-weight: 600;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #4285f4;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        button:hover {
            background-color: #1a73e8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .green-btn {
            background-color: #0f9d58;
        }
        .green-btn:hover {
            background-color: #0b8043;
        }
        .orange-btn {
            background-color: #ff9800;
        }
        .orange-btn:hover {
            background-color: #f57c00;
        }
        .red-btn {
            background-color: #ea4335;
        }
        .red-btn:hover {
            background-color: #d93025;
        }
        .item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.3s ease;
        }
        .item:hover {
            border-color: #4285f4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .coords {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        .notes {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .status {
            margin: 15px 0;
            padding: 12px;
            background-color: #e8f0fe;
            border-radius: 8px;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        h1 {
            text-align: center;
            margin: 30px 0;
            font-size: 32px;
            color: #1a73e8;
            font-weight: 700;
        }
        .flex {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .export-btn {
            flex: 1;
            min-width: 120px;
        }
        @media (max-width: 600px) {
            .flex {
                flex-direction: column;
            }
            .export-btn {
                width: 100%;
            }
            .container {
                padding: 10px;
            }
            .card {
                padding: 15px;
            }
        }
        .manual-coords {
            display: none;
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ffeeba;
            animation: fadeIn 0.3s ease-in-out;
        }
        .coord-input {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        .coord-input input {
            margin-bottom: 0;
        }
        .helper-text {
            color: #666;
            font-size: 14px;
            margin: 5px 0 15px;
            padding: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
        }
        .location-help {
            display: none;
            background-color: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
            animation: fadeIn 0.3s ease-in-out;
        }
        .location-help ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        .location-help li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 20px;
        }
        .location-help li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #dc3545;
        }
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #4285f4;
            color: white;
            border-radius: 50%;
            margin-right: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        .diagnostic {
            display: none;
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ffeeba;
            font-family: monospace;
            line-height: 1.4;
        }
        .install-button {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 24px;
            padding: 12px 24px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .install-button:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .action-buttons button {
            padding: 8px 16px;
            font-size: 14px;
            margin-bottom: 0;
            flex: 1;
        }
        .edit-mode {
            background-color: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 15px;
        }
        .species-select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .species-select:focus {
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        .species-manager {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .species-list {
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background-color: white;
        }
        .species-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        .species-item:hover {
            background-color: #f5f5f5;
        }
        .species-item:last-child {
            border-bottom: none;
        }
        .import-section {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #cce5ff;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .import-area {
            background-color: white;
            border: 2px solid #cce5ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        .file-input-container input[type="file"] {
            padding: 12px;
            border: 2px dashed #4285f4;
            border-radius: 8px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-input-container input[type="file"]:hover {
            background-color: #e3f2fd;
            border-color: #1a73e8;
        }
        .species-select-container {
            position: relative;
            margin-bottom: 15px;
        }
        .species-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .species-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            animation: fadeIn 0.2s ease-in-out;
        }
        .species-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
        }
        .species-suggestion:hover {
            background-color: #f5f5f5;
        }
        .species-suggestion.selected {
            background-color: #e3f2fd;
            color: #1a73e8;
        }
        .highlight {
            background-color: #fff176;
            padding: 0 2px;
            border-radius: 2px;
        }
        .footer {
            margin-top: 40px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 12px;
            font-size: 14px;
            color: #666;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .footer p {
            margin: 8px 0;
            line-height: 1.6;
        }
        .footer .citation {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }
        .footer .donation {
            margin: 25px 0;
            padding: 20px;
            background-color: #e8f5e9;
            border-radius: 12px;
            border: 1px solid #c8e6c9;
            transition: all 0.3s ease;
        }
        .footer .donation:hover {
            background-color: #c8e6c9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .footer .pix-key {
            font-family: monospace;
            background-color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
            display: inline-block;
            margin-top: 10px;
            font-size: 16px;
            user-select: all;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .footer .pix-key:hover {
            background-color: #f5f5f5;
            border-color: #4caf50;
        }
        .documentation-link {
            margin: 25px 0;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 12px;
            border: 1px solid #bbdefb;
            transition: all 0.3s ease;
        }
        .documentation-link:hover {
            background-color: #bbdefb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .documentation-link a {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        .documentation-link a:hover {
            color: #1565c0;
            text-decoration: underline;
        }
        .beta-notice {
            margin: 25px 0;
            padding: 20px;
            background-color: #fff3e0;
            border-radius: 12px;
            border: 1px solid #ffe0b2;
            text-align: center;
            transition: all 0.3s ease;
        }
        .beta-notice:hover {
            background-color: #ffe0b2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .pwa-install-info {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
            font-size: 14px;
        }
        .install-instructions {
            background-color: #e8f5e9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border: 1px solid #c8e6c9;
            transition: all 0.3s ease;
        }
        .install-instructions:hover {
            background-color: #c8e6c9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .install-instructions p {
            margin: 12px 0;
        }
        .helper-text {
            color: #2e7d32;
            font-style: italic;
        }
        .install-notes {
            margin-top: 15px;
            padding-left: 25px;
        }
        .install-notes li {
            margin-bottom: 8px;
            position: relative;
        }
        .install-notes li:before {
            content: "→";
            position: absolute;
            left: -20px;
            color: #4caf50;
        }
        
        /* Estilos dos Modais */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }
        .modal-content {
            background: white;
            max-width: 90%;
            width: 500px;
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            margin: -25px -25px 20px;
            padding: 20px 25px;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .modal-header h3 {
            margin: 0;
            color: #1a73e8;
            font-size: 20px;
        }
        .modal-body {
            margin-bottom: 25px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin: 25px -25px -25px;
            padding: 20px 25px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            border-top: 1px solid #e0e0e0;
        }
        .modal-footer button {
            margin: 0;
            width: auto;
            min-width: 120px;
        }
        .stats-container {
            padding: 15px;
        }
        .chart-container {
            margin-bottom: 20px;
            height: 400px;
        }
        .stats-summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .stats-table th, .stats-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .stats-table th {
            background-color: #f0f0f0;
        }
        .stats-table tr:nth-child(even) {
            background-color: #f8f8f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BioPlan</h1>
        
        <div id="status" class="status"></div>
        
        <!-- Projetos -->
        <div class="card">
            <div class="section-title">Projetos</div>
            <input type="text" id="projectName" placeholder="Nome do novo projeto">
            <button id="createBtn">Criar Projeto</button>
            <select id="projectSelect">
                <option value="">Selecione um projeto</option>
            </select>
            <button id="deleteProjectBtn" class="red-btn">Excluir Projeto</button>
        </div>

        <!-- Coleta -->
        <div class="card">
            <div class="section-title">Coleta de Dados</div>
            <label>Espécie:</label>
            <div class="species-select-container">
                <input type="text" id="speciesInput" class="species-input" placeholder="Digite para buscar espécies...">
                <div id="speciesSuggestions" class="species-suggestions"></div>
            </div>
            <label>Abundância:</label>
            <input type="number" id="abundance" placeholder="Quantidade">
            <label>Observação:</label>
            <textarea id="notes" rows="3"></textarea>
            <button id="locationBtn" class="green-btn">Capturar Localização</button>
            <button id="googleMapsBtn" class="green-btn">Localização via Google Maps</button>
            <div id="mapsContainer" class="maps-container" style="display: none;">
                <div class="maps-info">
                    <p><strong>Para obter coordenadas do Google Maps:</strong></p>
                    <ol>
                        <li>Abra o <a href="https://maps.google.com" target="_blank">Google Maps</a></li>
                        <li>Navegue até o local desejado</li>
                        <li>Clique e segure na localização para obter as coordenadas</li>
                        <li>Copie as coordenadas e insira-as abaixo</li>
                    </ol>
                </div>
                <div class="coord-input">
                    <input type="number" id="mapsLatInput" placeholder="Latitude" step="0.000001">
                    <input type="number" id="mapsLngInput" placeholder="Longitude" step="0.000001">
                </div>
                <div class="maps-buttons">
                    <button id="saveMapsCoords" class="green-btn">Salvar Coordenadas</button>
                    <button id="closeMapsBtn" class="red-btn">Cancelar</button>
                </div>
            </div>
            <div id="diagnostic" class="diagnostic"></div>
            
            <div id="locationHelp" class="location-help">
                <p><strong>Problema ao acessar localização.</strong></p>
                <p>Para permitir acesso à localização:</p>
                <ul>
                    <li>Nas configurações do Chrome: "Configurações do site" → "Localização" → Permitir</li>
                    <li>Nas configurações do Android: "Aplicativos" → "Chrome" → "Permissões" → "Localização" → Permitir</li>
                    <li>Ative o GPS do seu dispositivo</li>
                    <li>Tente usar outro navegador como Firefox</li>
                </ul>
                <button id="tryAgainBtn" class="green-btn">Tentar Novamente</button>
                <button id="tryAlternativeBtn" class="orange-btn">Usar Método Alternativo</button>
                <button id="closeHelpBtn" class="red-btn">Fechar Ajuda</button>
            </div>
            
            <button id="manualBtn" class="orange-btn">Inserir Coordenadas Manualmente</button>
            
            <div id="manualCoords" class="manual-coords">
                <div class="coord-input">
                    <input type="number" id="latInput" placeholder="Latitude" step="0.000001">
                    <input type="number" id="lngInput" placeholder="Longitude" step="0.000001">
                </div>
                <div class="helper-text">Exemplo: Latitude -23.550520, Longitude -46.633308</div>
                <button id="saveCoords" class="green-btn">Salvar Coordenadas</button>
            </div>
            
            <button id="saveBtn">Salvar Dados</button>
        </div>

        <!-- Gerenciamento -->
        <div class="card-collapsible">
            <div class="card-header" onclick="toggleCard('speciesCard')">
                <h3>Gerenciar Espécies</h3>
                <button class="orange-btn export-btn">Mostrar/Ocultar</button>
            </div>
            <div id="speciesCard" class="card-content">
                <!-- Adicionar espécies manualmente -->
                <div class="manual-add-section">
                    <h4 style="margin: 0 0 10px 0;">Adicionar Espécie</h4>
                    <input type="text" id="newSpecies" placeholder="Nome da nova espécie">
                    <button id="addSpeciesBtn" class="green-btn">Adicionar Espécie</button>
                </div>

                <!-- Lista de espécies -->
                <div class="species-list" id="speciesList">
                    <!-- Espécies serão adicionadas aqui -->
                </div>

                <!-- Seção de importação -->
                <div class="import-section">
                    <h4 style="margin: 10px 0;">Importar Espécies</h4>
                    <div class="import-area">
                        <p class="helper-text">Selecione um arquivo Excel (.xlsx, .xls), CSV ou TXT com nomes de espécies (um por linha).</p>
                        <div class="file-input-container">
                            <input type="file" id="importExcel" accept=".xlsx, .xls, .csv, .txt">
                            <button id="importExcelBtn" class="green-btn">Importar Espécies</button>
                        </div>
                        <button id="testXLSXBtn" class="orange-btn" style="margin-top: 5px;">Verificar Biblioteca XLSX</button>
                        <div id="importDiagnostic" class="diagnostic"></div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button id="importTxtBtn" class="orange-btn">Importar de TXT (Método Alternativo)</button>
                        <p class="helper-text">Use esta opção se a importação normal não funcionar.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados Coletados -->
        <div class="card-collapsible">
            <div class="card-header" onclick="toggleCard('dataCard')">
                <h3>Dados Coletados</h3>
                <div>
                    <button id="exportBtn" class="green-btn export-btn">Exportar Excel</button>
                    <button id="exportMultipleBtn" class="green-btn export-btn">Exportar Múltiplos</button>
                    <button class="orange-btn export-btn">Mostrar/Ocultar</button>
                </div>
            </div>
            <div id="dataCard" class="card-content">
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">⚠️ Os dados são armazenados apenas localmente no seu dispositivo. Faça backup regular exportando para Excel.</p>
                <div id="dataList"></div>
            </div>
        </div>

        <!-- Modal de Exportação Múltipla -->
        <div id="exportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; max-width: 90%; width: 500px; margin: 20px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
                <h3 style="margin-top: 0;">Exportar Múltiplos Projetos</h3>
                
                <div id="projectList" style="margin: 15px 0;">
                    <!-- Checkboxes serão adicionados aqui -->
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button id="cancelExportBtn" style="background-color: #9e9e9e; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                    <button id="exportSelectedBtn" style="background-color: #0f9d58; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Exportar Selecionados</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="donation" style="font-size: 14px;">
                <p><strong>Se o App foi útil para você, faça uma doação por Pix:</strong></p>
                <p>Chave aleatória: <span class="pix-key">3c37c492-cebe-4927-b7db-68b004b67c99</span></p>
            </div>

            <div class="citation">
                <p><strong>Citar como:</strong></p>
                <p>RANGEL, Danilo Freitas. WebApp BioPlan. 2025. Disponível em: &lt;https://danilofr1.github.io/biop/&gt;. Acesso em: DATA MES. ANO.</p>
                <p><strong>Contato:</strong> drangel@unifesp.br</p>
                <p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"><a property="dct:title" rel="cc:attributionURL" href="https://danilofr1.github.io/biop/">BioPlan</a> by <span property="cc:attributionName">Danilo Freitas Rangel</span> is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-SA 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a></p>
            </div>

            <div class="documentation-link">
                <p><strong>📖 Documentação:</strong></p>
                <p>Para entender todas as funcionalidades do BioPlan, consulte o <a href="readme.html" target="_blank">Manual do Usuário</a></p>
            </div>

            <div class="beta-notice" style="margin-top: 15px; padding: 10px; background-color: #fff3e0; border-radius: 4px; text-align: center;">
                <p><strong>⚠️ Versão Beta</strong></p>
                <p>Este é um aplicativo em desenvolvimento (Beta) e sem fins lucrativos.</p>
            </div>

            <div class="pwa-install-info">
                <p><strong>📱 Instale o BioPlan no seu dispositivo:</strong></p>
                <div class="install-instructions">
                    <p><strong>Samsung:</strong> Use o Samsung Internet e toque em Menu (☰) → "Adicionar página à" → "Tela inicial" → "Instalar"</p>
                    <p><strong>Outros:</strong> No Chrome, toque em Menu (⋮) → "Adicionar à tela inicial"</p>
                    <p class="helper-text">Após instalado, o app funcionará offline! Observações importantes:</p>
                    <ul class="install-notes">
                        <li>No Chrome, especialmente em dispositivos Samsung, o funcionamento offline pode ser limitado</li>
                        <li>Para melhor experiência em dispositivos Samsung, use o Samsung Internet</li>
                        <li>É necessário acessar o app online pela primeira vez antes de usar offline</li>
                        <li>Após instalado, use sempre o ícone na tela inicial para abrir o app</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de edição -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 90%; width: 500px; margin: 20px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top: 0;">Editar Registro</h3>
            
            <div style="margin-bottom: 15px;">
                <label>Espécie:</label>
                <div class="species-select-container">
                    <input type="text" id="editSpeciesInput" class="species-input" placeholder="Digite para buscar espécies...">
                    <div id="editSpeciesSuggestions" class="species-suggestions"></div>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Abundância:</label>
                <input type="number" id="editAbundance" placeholder="Quantidade">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Observação:</label>
                <textarea id="editNotes" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>Coordenadas:</label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <input type="number" id="editLat" placeholder="Latitude" step="0.000001" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="number" id="editLng" placeholder="Longitude" step="0.000001" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancelEditBtn" style="background-color: #9e9e9e; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button id="saveEditBtn" style="background-color: #0f9d58; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis
        var projects = {};
        var currentProject = null;
        var currentLocation = null;
        var watchId = null;
        var locationUpdateCount = 0;
        var speciesList = []; // Será preenchido a partir do localStorage

        // Elementos 
        var statusEl = document.getElementById("status");
        var projectNameEl = document.getElementById("projectName");
        var projectSelectEl = document.getElementById("projectSelect");
        var createBtnEl = document.getElementById("createBtn");
        var deleteProjectBtnEl = document.getElementById("deleteProjectBtn");
        var locationBtnEl = document.getElementById("locationBtn");
        var googleMapsBtnEl = document.getElementById("googleMapsBtn");
        var mapsContainerEl = document.getElementById("mapsContainer");
        var mapsLatInputEl = document.getElementById("mapsLatInput");
        var mapsLngInputEl = document.getElementById("mapsLngInput");
        var saveMapsCoordsEl = document.getElementById("saveMapsCoords");
        var closeMapsBtn = document.getElementById("closeMapsBtn");
        var diagnosticEl = document.getElementById("diagnostic");
        var locationHelpEl = document.getElementById("locationHelp");
        var tryAgainBtnEl = document.getElementById("tryAgainBtn");
        var tryAlternativeBtnEl = document.getElementById("tryAlternativeBtn");
        var closeHelpBtnEl = document.getElementById("closeHelpBtn");
        var manualBtnEl = document.getElementById("manualBtn");
        var manualCoordsEl = document.getElementById("manualCoords");
        var latInputEl = document.getElementById("latInput");
        var lngInputEl = document.getElementById("lngInput");
        var saveCoordsEl = document.getElementById("saveCoords");
        var speciesSelectEl = document.getElementById("speciesSelect");
        var abundanceEl = document.getElementById("abundance");
        var notesEl = document.getElementById("notes");
        var saveBtnEl = document.getElementById("saveBtn");
        var exportBtnEl = document.getElementById("exportBtn");
        var dataListEl = document.getElementById("dataList");
        var speciesManagerEl = document.getElementById("speciesManager");
        var newSpeciesEl = document.getElementById("newSpecies");
        var addSpeciesBtnEl = document.getElementById("addSpeciesBtn");
        var speciesListEl = document.getElementById("speciesList");
        var importExcelEl = document.getElementById("importExcel");
        var importExcelBtnEl = document.getElementById("importExcelBtn");
        var testXLSXBtnEl = document.getElementById("testXLSXBtn");
        var importTxtBtnEl = document.getElementById("importTxtBtn");

        // Elementos adicionados para autocomplete
        var speciesInputEl = document.getElementById("speciesInput");
        var speciesSuggestionsEl = document.getElementById("speciesSuggestions");
        var selectedSpecies = "";

        // Inicialização
        function init() {
            showStatus("Iniciando aplicativo...");
            
            // Carregar projetos
            try {
                var savedData = window.localStorage.getItem("bioProjects");
                if (savedData) {
                    projects = JSON.parse(savedData);
                    updateProjectList();
                    showStatus("Dados carregados com sucesso!");
                } else {
                    showStatus("Nenhum projeto encontrado. Crie um novo.");
                }
            } catch (e) {
                showStatus("ERRO ao carregar dados: " + e.message);
            }
            
            // Carregar espécies
            loadSpecies();
            
            // Configurar eventos
            createBtnEl.onclick = createProject;
            deleteProjectBtnEl.onclick = deleteProject;
            projectSelectEl.onchange = loadProject;
            locationBtnEl.onclick = captureLocation;
            googleMapsBtnEl.onclick = toggleGoogleMaps;
            saveMapsCoordsEl.onclick = saveMapsCoords;
            closeMapsBtn.onclick = function() {
                mapsContainerEl.style.display = "none";
            };
            tryAgainBtnEl.onclick = function() {
                locationHelpEl.style.display = "none";
                captureLocation();
            };
            tryAlternativeBtnEl.onclick = function() {
                locationHelpEl.style.display = "none";
                useAlternativeLocation();
            };
            closeHelpBtnEl.onclick = function() {
                locationHelpEl.style.display = "none";
            };
            manualBtnEl.onclick = toggleManualCoords;
            saveCoordsEl.onclick = saveManualCoords;
            saveBtnEl.onclick = saveData;
            exportBtnEl.onclick = exportExcel;

            // Eventos de exportação múltipla
            document.getElementById('exportMultipleBtn').onclick = openExportModal;
            document.getElementById('cancelExportBtn').onclick = closeExportModal;
            document.getElementById('exportSelectedBtn').onclick = exportMultipleProjects;
            
            // Eventos de gerenciamento de espécies
            if (addSpeciesBtnEl) {
                addSpeciesBtnEl.onclick = addSpecies;
            }
            
            // Eventos do modal de edição
            var saveEditBtn = document.getElementById('saveEditBtn');
            var cancelEditBtn = document.getElementById('cancelEditBtn');
            if (saveEditBtn) {
                saveEditBtn.addEventListener('click', saveEdit);
            }
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    var editModal = document.getElementById('editModal');
                    if (editModal) {
                        editModal.style.display = 'none';
                    }
                });
            }
            
            // Verificar suporte à geolocalização
            checkGeolocationSupport();

            // Evento para importar espécies de Excel/CSV/TXT
            importExcelBtnEl.onclick = function() {
                // Limpar mensagens anteriores
                var importDiagnosticEl = document.getElementById('importDiagnostic');
                importDiagnosticEl.innerHTML = "";
                importDiagnosticEl.style.display = "block";
                
                logImportDiagnostic("Iniciando importação de espécies");
                
                // Verificar se um arquivo foi selecionado
                var fileInput = document.getElementById('importExcel');
                if (!fileInput.files.length) {
                    showStatus("Selecione um arquivo primeiro");
                    logImportDiagnostic("Nenhum arquivo selecionado");
                    return;
                }
                
                var file = fileInput.files[0];
                logImportDiagnostic("Arquivo selecionado: " + file.name);
                showStatus("Processando arquivo " + file.name + "...");
                
                // Determinar tipo de arquivo
                var fileName = file.name.toLowerCase();
                var isCSV = fileName.endsWith('.csv');
                var isTXT = fileName.endsWith('.txt');
                var isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                
                logImportDiagnostic("Tipo de arquivo: " + (isExcel ? "Excel" : (isCSV ? "CSV" : "TXT")));
                
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        logImportDiagnostic("Arquivo lido com sucesso");
                        
                        var speciesData = [];
                        
                        if (isCSV || isTXT) {
                            // Processar CSV ou TXT (ambos são tratados como texto)
                            var content = e.target.result;
                            var lines = content.split(/\r?\n/); // Suporta quebras de linha Windows e Unix
                            logImportDiagnostic("Linhas encontradas: " + lines.length);
                            
                            for (var i = 0; i < lines.length; i++) {
                                var line = lines[i].trim();
                                if (line) {
                                    if (isCSV) {
                                        // Para CSV, pegamos apenas a primeira coluna
                                        var parts = line.split(',');
                                        if (parts.length > 0 && parts[0].trim()) {
                                            speciesData.push(parts[0].trim());
                                        }
                                    } else {
                                        // Para TXT, cada linha é uma espécie
                                        speciesData.push(line);
                                    }
                                }
                            }
                        } else if (isExcel) {
                            // Verificar se a biblioteca SheetJS está disponível
                            if (typeof XLSX === 'undefined') {
                                throw new Error("Biblioteca XLSX não disponível. Tente usar um arquivo CSV ou TXT.");
                            }
                            
                            // Processar Excel
                            var data = new Uint8Array(e.target.result);
                            logImportDiagnostic("Lendo arquivo Excel...");
                            
                            try {
                                var workbook = XLSX.read(data, {type: 'array'});
                                logImportDiagnostic("Workbook lido com sucesso");
                                
                                if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                                    throw new Error("Arquivo Excel inválido ou vazio");
                                }
                                
                                var sheetName = workbook.SheetNames[0];
                                logImportDiagnostic("Lendo planilha: " + sheetName);
                                
                                var worksheet = workbook.Sheets[sheetName];
                                var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                                
                                logImportDiagnostic("Dados extraídos: " + jsonData.length + " linhas");
                                
                                // Extrair primeira coluna de cada linha
                                for (var i = 0; i < jsonData.length; i++) {
                                    var row = jsonData[i];
                                    if (row && row.length > 0 && row[0] !== undefined && row[0] !== null) {
                                        var speciesName = row[0].toString().trim();
                                        if (speciesName) {
                                            speciesData.push(speciesName);
                                        }
                                    }
                                }
                            } catch (excelError) {
                                logImportDiagnostic("Erro ao processar Excel: " + excelError.message);
                                throw new Error("Erro ao processar arquivo Excel: " + excelError.message);
                            }
                        } else {
                            throw new Error("Formato de arquivo não suportado. Use Excel, CSV ou TXT.");
                        }
                        
                        // Verificar se temos dados
                        if (speciesData.length === 0) {
                            throw new Error("Nenhuma espécie encontrada no arquivo");
                        }
                        
                        logImportDiagnostic("Espécies encontradas: " + speciesData.length);
                        
                        // Adicionar espécies à lista
                        var addedCount = 0;
                        var duplicateCount = 0;
                        
                        for (var i = 0; i < speciesData.length; i++) {
                            var speciesName = speciesData[i];
                            
                            if (!speciesList.includes(speciesName)) {
                                speciesList.push(speciesName);
                                logImportDiagnostic("Espécie adicionada: " + speciesName);
                                addedCount++;
                            } else {
                                logImportDiagnostic("Espécie duplicada ignorada: " + speciesName);
                                duplicateCount++;
                            }
                        }
                        
                        // Salvar e atualizar a interface
                        window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                        updateSpeciesList();
                        populateSpeciesDropdowns();
                        
                        // Mostrar resultado
                        var message = "Importação concluída: " + addedCount + " espécies adicionadas";
                        if (duplicateCount > 0) {
                            message += ", " + duplicateCount + " duplicadas ignoradas";
                        }
                        
                        showStatus(message);
                        logImportDiagnostic("SUCESSO: " + message);
                        
                        // Limpar o campo de arquivo
                        fileInput.value = "";
                        
                    } catch (error) {
                        logImportDiagnostic("ERRO: " + error.message);
                        showStatus("ERRO ao processar arquivo: " + error.message);
                    }
                };
                
                reader.onerror = function() {
                    logImportDiagnostic("ERRO ao ler o arquivo");
                    showStatus("ERRO ao ler o arquivo");
                };
                
                // Ler o arquivo no formato adequado
                if (isCSV || isTXT) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            };

            // Adicionar evento para testar a biblioteca XLSX
            testXLSXBtnEl.addEventListener('click', function() {
                var importDiagnosticEl = document.getElementById('importDiagnostic');
                importDiagnosticEl.innerHTML = "";
                importDiagnosticEl.style.display = "block";
                
                if (typeof XLSX === 'undefined') {
                    logImportDiagnostic("ERRO: Biblioteca XLSX não está disponível!");
                    showStatus("ERRO: Biblioteca XLSX não está disponível!");
                } else {
                    logImportDiagnostic("SUCESSO: Biblioteca XLSX está disponível (versão: " + (XLSX.version || "desconhecida") + ")");
                    showStatus("Biblioteca XLSX está disponível!");
                    
                    // Criar um workbook simples para testar
                    try {
                        var wb = XLSX.utils.book_new();
                        var ws = XLSX.utils.aoa_to_sheet([["Teste"]]);
                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                        logImportDiagnostic("SUCESSO: Teste de criação de workbook funcionou!");
                    } catch (e) {
                        logImportDiagnostic("ERRO ao testar workbook: " + e.message);
                    }
                }
            });

            // Adicionar evento para importação simplificada de TXT
            importTxtBtnEl.addEventListener('click', function() {
                var importDiagnosticEl = document.getElementById('importDiagnostic');
                importDiagnosticEl.innerHTML = "";
                importDiagnosticEl.style.display = "block";
                
                var fileInput = document.getElementById('importExcel');
                if (!fileInput.files.length) {
                    showStatus("Selecione um arquivo TXT primeiro");
                    logImportDiagnostic("Nenhum arquivo selecionado");
                    return;
                }
                
                var file = fileInput.files[0];
                var fileName = file.name.toLowerCase();
                
                if (!fileName.endsWith('.txt') && !fileName.endsWith('.csv')) {
                    showStatus("Por favor, selecione um arquivo TXT ou CSV para este método");
                    logImportDiagnostic("Arquivo inválido para importação simplificada: " + fileName);
                    return;
                }
                
                logImportDiagnostic("Iniciando importação simplificada de: " + file.name);
                
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        var content = e.target.result;
                        var lines = content.split(/\r?\n/);
                        var validLines = [];
                        
                        // Filtrar linhas vazias
                        for (var i = 0; i < lines.length; i++) {
                            var line = lines[i].trim();
                            if (line) {
                                if (fileName.endsWith('.csv')) {
                                    // Para CSV, pegamos apenas a primeira coluna
                                    var parts = line.split(',');
                                    if (parts.length > 0 && parts[0].trim()) {
                                        validLines.push(parts[0].trim());
                                    }
                                } else {
                                    // Para TXT, cada linha é uma espécie
                                    validLines.push(line);
                                }
                            }
                        }
                        
                        if (validLines.length === 0) {
                            throw new Error("Nenhuma espécie encontrada no arquivo");
                        }
                        
                        logImportDiagnostic("Espécies encontradas: " + validLines.length);
                        
                        // Adicionar espécies à lista
                        var addedCount = 0;
                        var duplicateCount = 0;
                        
                        for (var i = 0; i < validLines.length; i++) {
                            var speciesName = validLines[i];
                            
                            if (!speciesList.includes(speciesName)) {
                                speciesList.push(speciesName);
                                logImportDiagnostic("Espécie adicionada: " + speciesName);
                                addedCount++;
                            } else {
                                logImportDiagnostic("Espécie duplicada ignorada: " + speciesName);
                                duplicateCount++;
                            }
                        }
                        
                        // Salvar e atualizar a interface
                        window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                        updateSpeciesList();
                        populateSpeciesDropdowns();
                        
                        // Mostrar resultado
                        var message = "Importação concluída: " + addedCount + " espécies adicionadas";
                        if (duplicateCount > 0) {
                            message += ", " + duplicateCount + " duplicadas ignoradas";
                        }
                        
                        showStatus(message);
                        logImportDiagnostic("SUCESSO: " + message);
                        
                        // Limpar o campo de arquivo
                        fileInput.value = "";
                        
                    } catch (error) {
                        logImportDiagnostic("ERRO: " + error.message);
                        showStatus("ERRO ao processar arquivo: " + error.message);
                    }
                };
                
                reader.onerror = function() {
                    logImportDiagnostic("ERRO ao ler o arquivo");
                    showStatus("ERRO ao ler o arquivo");
                };
                
                reader.readAsText(file);
            });

            // Função para inicializar o autocomplete
            initAutocomplete();
        }

        // Carregar espécies do localStorage
        function loadSpecies() {
            try {
                var savedSpecies = window.localStorage.getItem("bioSpecies");
                if (savedSpecies) {
                    speciesList = JSON.parse(savedSpecies);
                } else {
                    // Espécies padrão se não houver nenhuma salva
                    speciesList = ["Espécie A", "Espécie B", "Espécie C"];
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                }
                updateSpeciesList();
            } catch (e) {
                console.error("Erro ao carregar espécies:", e);
                logDiagnostic("Erro ao carregar espécies: " + e.message);
            }
        }

        // Alternar exibição do gerenciador de espécies
        function toggleSpeciesManager() {
            if (speciesManagerEl.style.display === "block") {
                speciesManagerEl.style.display = "none";
                toggleSpeciesBtnEl.textContent = "Mostrar";
            } else {
                speciesManagerEl.style.display = "block";
                toggleSpeciesBtnEl.textContent = "Ocultar";
            }
        }

        // Adicionar nova espécie
        function addSpecies() {
            var newSpeciesName = newSpeciesEl.value.trim();
            
            if (!newSpeciesName) {
                showStatus("Digite um nome para a espécie");
                return;
            }
            
            if (speciesList.includes(newSpeciesName)) {
                showStatus("Esta espécie já existe");
                return;
            }
            
            speciesList.push(newSpeciesName);
            window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
            
            newSpeciesEl.value = "";
            updateSpeciesList();
            
            showStatus("Espécie adicionada com sucesso!");
        }

        // Remover espécie
        function removeSpecies(speciesName) {
            var index = speciesList.indexOf(speciesName);
            if (index !== -1) {
                if (confirm("Tem certeza que deseja remover a espécie '" + speciesName + "'?")) {
                    speciesList.splice(index, 1);
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                    updateSpeciesList();
                    showStatus("Espécie removida com sucesso!");
                }
            }
        }

        // Atualizar lista de espécies no gerenciador
        function updateSpeciesList() {
            if (!speciesListEl) {
                console.error("Elemento da lista de espécies não encontrado");
                return;
            }
            
            speciesListEl.innerHTML = "";
            
            if (speciesList.length === 0) {
                speciesListEl.innerHTML = "<p>Nenhuma espécie cadastrada</p>";
                return;
            }
            
            for (var i = 0; i < speciesList.length; i++) {
                var speciesName = speciesList[i];
                
                var div = document.createElement("div");
                div.className = "species-item";
                div.innerHTML = 
                    "<span>" + speciesName + "</span>" +
                    "<button class='red-btn delete-species-btn' data-species='" + speciesName + "'>Remover</button>";
                
                speciesListEl.appendChild(div);
            }
            
            // Adicionar eventos aos botões de remoção
            var deleteButtons = document.querySelectorAll('.delete-species-btn');
            deleteButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var speciesName = this.getAttribute('data-species');
                    removeSpecies(speciesName);
                });
            });
        }

        // Preencher dropdown de espécies
        function populateSpeciesDropdowns() {
            // Limpar dropdowns
            speciesSelectEl.innerHTML = "<option value=''>Selecione uma espécie</option>";
            document.getElementById('editSpeciesInput').innerHTML = "<option value=''>Selecione uma espécie</option>";
            
            // Preencher com espécies atualizadas
            speciesList.forEach(function(species) {
                var option = document.createElement("option");
                option.value = species;
                option.textContent = species;
                speciesSelectEl.appendChild(option);
                
                var editOption = option.cloneNode(true);
                document.getElementById('editSpeciesInput').appendChild(editOption);
            });
        }

        // Alternar exibição do Google Maps
        function toggleGoogleMaps() {
            if (mapsContainerEl.style.display === "block") {
                mapsContainerEl.style.display = "none";
            } else {
                mapsContainerEl.style.display = "block";
                mapsLatInputEl.value = "";
                mapsLngInputEl.value = "";
                
                // Fechar outros painéis de localização
                manualCoordsEl.style.display = "none";
                manualBtnEl.textContent = "Inserir Coordenadas Manualmente";
                locationHelpEl.style.display = "none";
            }
        }

        // Salvar coordenadas do Google Maps
        function saveMapsCoords() {
            var lat = parseFloat(mapsLatInputEl.value);
            var lng = parseFloat(mapsLngInputEl.value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showStatus("Digite valores válidos para latitude e longitude");
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showStatus("Coordenadas fora dos limites válidos");
                return;
            }
            
            currentLocation = {
                latitude: lat,
                longitude: lng,
                accuracy: 0, // Precisão desconhecida para coordenadas manuais
                timestamp: new Date().toISOString()
            };
            
            showStatus("Coordenadas do Google Maps salvas!");
            mapsContainerEl.style.display = "none";
        }

        // Mostrar mensagem de status
        function showStatus(message) {
            statusEl.style.display = "block";
            statusEl.innerText = message;
            setTimeout(function() {
                statusEl.style.display = "none";
            }, 3000);
        }
        
        // Registrar diagnóstico
        function logDiagnostic(message) {
            var now = new Date();
            var timestamp = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();
            diagnosticEl.innerHTML += timestamp + ' - ' + message + '<br>';
            diagnosticEl.style.display = "block";
            diagnosticEl.scrollTop = diagnosticEl.scrollHeight;
        }

        // Criar projeto
        function createProject() {
            var name = projectNameEl.value.trim();
            
            if (!name) {
                showStatus("Digite um nome para o projeto");
                return;
            }
            
            if (projects[name]) {
                showStatus("Este projeto já existe");
                return;
            }
            
            try {
                projects[name] = { data: [] };
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                projectNameEl.value = "";
                updateProjectList();
                
                // Selecionar o novo projeto
                projectSelectEl.value = name;
                currentProject = name;
                
                showStatus("Projeto criado: " + name);
            } catch (e) {
                showStatus("ERRO ao criar projeto: " + e.message);
            }
        }

        // Excluir projeto
        function deleteProject() {
            if (!currentProject) {
                showStatus("Selecione um projeto para excluir");
                return;
            }
            
            if (confirm("Tem certeza que deseja excluir o projeto '" + currentProject + "'?")) {
                delete projects[currentProject];
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                currentProject = null;
                updateProjectList();
                dataListEl.innerHTML = "";
                showStatus("Projeto excluído com sucesso!");
            }
        }

        // Atualizar lista de projetos
        function updateProjectList() {
            // Limpar lista
            projectSelectEl.innerHTML = "<option value=''>Selecione um projeto</option>";
            
            // Adicionar projetos
            for (var name in projects) {
                var option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                projectSelectEl.appendChild(option);
            }
        }

        // Carregar projeto selecionado
        function loadProject() {
            currentProject = projectSelectEl.value;
            if (currentProject) {
                showData();
                showStatus("Projeto carregado: " + currentProject);
            } else {
                dataListEl.innerHTML = "";
            }
        }
        
        // Método alternativo de localização
        function useAlternativeLocation() {
            logDiagnostic("Tentando método alternativo de geolocalização");
            
            // Interrompendo o watch atual se houver
            stopLocationWatch();
            
            locationBtnEl.disabled = true;
            locationBtnEl.textContent = "Capturando...";
            showStatus("Tentando método alternativo...");
            
            // Tentar uma abordagem diferente com menos precisão
            var options = {
                enableHighAccuracy: false,  // Menos precisão, maior chance de funcionar
                timeout: 10000,
                maximumAge: 60000  // Aceitar posições com até 1 minuto
            };
            
            if (!navigator.geolocation) {
                showStatus("Geolocalização não suportada");
                locationBtnEl.disabled = false;
                locationBtnEl.textContent = "Capturar Localização";
                toggleManualCoords();
                return;
            }
            
            try {
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        locationUpdateCount++;
                        
                        var accuracy = position.coords.accuracy;
                        logDiagnostic("Posição obtida #" + locationUpdateCount + " (precisão: " + Math.round(accuracy) + "m)");
                        
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Parar de observar após obter uma localização
                        stopLocationWatch();
                        
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        showStatus("Localização obtida! Precisão: " + Math.round(accuracy) + "m");
                    },
                    function(error) {
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        
                        logDiagnostic("Erro no método alternativo: " + error.code + " - " + error.message);
                        showStatus("Método alternativo falhou. Use entrada manual.");
                        toggleManualCoords();
                    },
                    options
                );
            } catch (e) {
                logDiagnostic("Exceção: " + e.message);
                locationBtnEl.disabled = false;
                locationBtnEl.textContent = "Capturar Localização";
                showStatus("Erro na geolocalização. Use entrada manual.");
                toggleManualCoords();
            }
        }

        // Capturar localização
        function captureLocation() {
            // Interrompendo o watch atual se houver
            stopLocationWatch();
            
            if (!navigator.geolocation) {
                showStatus("Seu navegador não suporta geolocalização");
                toggleManualCoords();
                return;
            }
            
            locationBtnEl.disabled = true;
            locationBtnEl.textContent = "Capturando...";
            showStatus("Obtendo sua localização...");
            logDiagnostic("Iniciando captura de localização");
            
            var options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            try {
                locationUpdateCount = 0;
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        locationUpdateCount++;
                        
                        var accuracy = position.coords.accuracy;
                        logDiagnostic("Posição obtida #" + locationUpdateCount + " (precisão: " + Math.round(accuracy) + "m)");
                        
                        // Se já temos uma localização e a precisão não é melhor, ignorar
                        if (currentLocation && accuracy >= currentLocation.accuracy) {
                            return;
                        }
                        
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Se a precisão for boa ou tivermos várias atualizações, parar
                        if (accuracy < 50 || locationUpdateCount > 5) {
                            stopLocationWatch();
                            locationBtnEl.disabled = false;
                            locationBtnEl.textContent = "Capturar Localização";
                            showStatus("Localização obtida! Precisão: " + Math.round(accuracy) + "m");
                        }
                    },
                    function(error) {
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        
                        logDiagnostic("Erro de geolocalização: " + error.code + " - " + error.message);
                        
                        // Código 1 = permissão negada
                        if (error.code === 1) {
                            showStatus("Permissão de localização negada");
                            locationHelpEl.style.display = "block";
                        } else if (error.code === 2) {
                            // Erro de disponibilidade - tente método alternativo
                            showStatus("Localização indisponível. Tentando alternativa...");
                            setTimeout(useAlternativeLocation, 1000);
                        } else {
                            showStatus("ERRO: " + error.message);
                            locationHelpEl.style.display = "block";
                        }
                    },
                    options
                );
            } catch (e) {
                logDiagnostic("Exceção: " + e.message);
                locationBtnEl.disabled = false;
                locationBtnEl.textContent = "Capturar Localização";
                showStatus("Erro na geolocalização. Use entrada manual.");
                toggleManualCoords();
            }
            
            // Tempo máximo para watch (30 segundos)
            setTimeout(function() {
                if (watchId !== null) {
                    logDiagnostic("Timeout da captura de localização");
                    if (currentLocation) {
                        // Usamos a melhor localização que conseguimos até agora
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        showStatus("Localização obtida (timeout)! Precisão: " + 
                                   Math.round(currentLocation.accuracy) + "m");
                    } else {
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        showStatus("Tempo esgotado. Use entrada manual.");
                        toggleManualCoords();
                    }
                }
            }, 30000);
        }
        
        // Parar de observar localização
        function stopLocationWatch() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                logDiagnostic("Observação de localização interrompida");
            }
        }
        
        // Alternar modo de entrada manual de coordenadas
        function toggleManualCoords() {
            if (manualCoordsEl.style.display === "block") {
                manualCoordsEl.style.display = "none";
                manualBtnEl.textContent = "Inserir Coordenadas Manualmente";
            } else {
                manualCoordsEl.style.display = "block";
                manualBtnEl.textContent = "Ocultar Entrada Manual";
            }
        }
        
        // Salvar coordenadas inseridas manualmente
        function saveManualCoords() {
            var lat = parseFloat(latInputEl.value);
            var lng = parseFloat(lngInputEl.value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showStatus("Digite valores válidos para latitude e longitude");
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showStatus("Coordenadas fora dos limites válidos");
                return;
            }
            
            currentLocation = {
                latitude: lat,
                longitude: lng,
                accuracy: 0, // Precisão desconhecida para coordenadas manuais
                timestamp: new Date().toISOString()
            };
            
            showStatus("Coordenadas salvas manualmente!");
            manualCoordsEl.style.display = "none";
            manualBtnEl.textContent = "Inserir Coordenadas Manualmente";
        }

        // Salvar dados
        function saveData() {
            if (!currentProject) {
                showStatus("Selecione um projeto primeiro");
                return;
            }
            
            if (!currentLocation) {
                showStatus("Capture a localização ou insira manualmente");
                return;
            }
            
            var species = speciesInputEl.value.trim();
            var abundance = parseInt(abundanceEl.value);
            var notes = notesEl.value.trim();
            
            if (!species) {
                showStatus("Digite uma espécie");
                return;
            }
            
            // Verificar se a espécie existe na lista
            if (!speciesList.includes(species)) {
                if (confirm("A espécie '" + species + "' não está na lista. Deseja adicioná-la?")) {
                    speciesList.push(species);
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                    updateSpeciesList();
                } else {
                    return;
                }
            }
            
            if (isNaN(abundance) || abundance < 0) {
                showStatus("Digite uma abundância válida");
                return;
            }
            
            // Remover validação de observação obrigatória
            
            try {
                var newData = {
                    species: species,
                    abundance: abundance,
                    latitude: currentLocation.latitude,
                    longitude: currentLocation.longitude,
                    accuracy: currentLocation.accuracy || 0,
                    timestamp: currentLocation.timestamp,
                    observation: notes,
                    manual: currentLocation.accuracy === 0
                };
                
                projects[currentProject].data.push(newData);
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                
                speciesInputEl.value = "";
                selectedSpecies = "";
                abundanceEl.value = "";
                notesEl.value = "";
                currentLocation = null;
                showData();
                showStatus("Dados salvos com sucesso!");
            } catch (e) {
                showStatus("ERRO ao salvar dados: " + e.message);
            }
        }

        // Mostrar dados
        function showData() {
            if (!currentProject) return;
            
            dataListEl.innerHTML = "";
            var data = projects[currentProject].data;
            
            if (data.length === 0) {
                dataListEl.innerHTML = "<p>Nenhum dado coletado</p>";
                return;
            }
            
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var date = new Date(item.timestamp);
                var isManual = item.manual ? " (Manual)" : "";
                var accuracyText = !item.manual && item.accuracy ? ` | Precisão: ${Math.round(item.accuracy)}m` : "";
                
                var div = document.createElement("div");
                div.className = "item";
                div.dataset.index = i;
                div.innerHTML = 
                    "<div class='coords'>Espécie: " + item.species + " | Abundância: " + item.abundance + "</div>" +
                    "<div class='coords'>Lat: " + item.latitude.toFixed(6) + 
                    " | Long: " + item.longitude.toFixed(6) + 
                    accuracyText + isManual + "</div>" +
                    "<div class='notes'>" + item.observation + "</div>" +
                    "<div class='coords'>" + date.toLocaleString() + "</div>" +
                    "<div class='action-buttons'>" +
                    "<button class='edit-btn orange-btn'>Editar</button>" +
                    "<button class='delete-btn red-btn'>Excluir</button>" +
                    "</div>";
                
                dataListEl.appendChild(div);
            }
            
            // Adicionar eventos de edição e exclusão
            var editButtons = document.querySelectorAll('.edit-btn');
            var deleteButtons = document.querySelectorAll('.delete-btn');
            
            editButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var itemDiv = this.parentNode.parentNode;
                    var index = parseInt(itemDiv.dataset.index);
                    openEditModal(index);
                });
            });
            
            deleteButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var itemDiv = this.parentNode.parentNode;
                    var index = parseInt(itemDiv.dataset.index);
                    deleteRecord(index);
                });
            });
        }
        
        // Abrir modal de edição
        function openEditModal(index) {
            var item = projects[currentProject].data[index];
            
            // Preencher o modal com os dados atuais
            document.getElementById('editSpeciesInput').value = item.species;
            document.getElementById('editAbundance').value = item.abundance;
            document.getElementById('editNotes').value = item.observation;
            document.getElementById('editLat').value = item.latitude;
            document.getElementById('editLng').value = item.longitude;
            
            // Armazenar o índice atual para uso posterior
            document.getElementById('editModal').dataset.currentIndex = index;
            
            // Mostrar o modal
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Salvar edições
        function saveEdit() {
            var index = parseInt(document.getElementById('editModal').dataset.currentIndex);
            var item = projects[currentProject].data[index];
            
            // Obter novos valores
            var newSpecies = document.getElementById('editSpeciesInput').value.trim();
            var newAbundance = parseInt(document.getElementById('editAbundance').value);
            var newObservation = document.getElementById('editNotes').value.trim();
            var newLat = parseFloat(document.getElementById('editLat').value);
            var newLng = parseFloat(document.getElementById('editLng').value);
            
            // Validar
            if (!newSpecies) {
                showStatus("Digite uma espécie");
                return;
            }
            
            // Verificar se a espécie existe na lista
            if (!speciesList.includes(newSpecies)) {
                if (confirm("A espécie '" + newSpecies + "' não está na lista. Deseja adicioná-la?")) {
                    speciesList.push(newSpecies);
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                    updateSpeciesList();
                } else {
                    return;
                }
            }
            
            if (isNaN(newAbundance) || newAbundance < 0) {
                showStatus("Digite uma abundância válida");
                return;
            }
            
            if (!newObservation) {
                showStatus("A observação não pode estar vazia");
                return;
            }
            
            if (isNaN(newLat) || isNaN(newLng) || newLat < -90 || newLat > 90 || newLng < -180 || newLng > 180) {
                showStatus("Coordenadas inválidas");
                return;
            }
            
            // Atualizar o item
            item.species = newSpecies;
            item.abundance = newAbundance;
            item.observation = newObservation;
            item.latitude = newLat;
            item.longitude = newLng;
            
            // Se as coordenadas foram alteradas, marcar como editado manualmente
            if (newLat !== item.latitude || newLng !== item.longitude) {
                item.manual = true;
                item.accuracy = 0;
            }
            
            // Salvar no localStorage
            window.localStorage.setItem("bioProjects", JSON.stringify(projects));
            
            // Fechar o modal
            document.getElementById('editModal').style.display = 'none';
            
            // Atualizar a visualização
            showData();
            showStatus("Registro atualizado com sucesso!");
        }
        
        // Excluir registro
        function deleteRecord(index) {
            if (confirm("Tem certeza que deseja excluir este registro?")) {
                // Remover o item do array
                projects[currentProject].data.splice(index, 1);
                
                // Salvar no localStorage
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                
                // Atualizar a visualização
                showData();
                showStatus("Registro excluído com sucesso!");
            }
        }

        // Exportar para Excel
        function exportExcel() {
            if (!currentProject) {
                showStatus("Selecione um projeto primeiro");
                return;
            }
            
            var data = projects[currentProject].data;
            if (data.length === 0) {
                showStatus("Nenhum dado para exportar");
                return;
            }
            
            try {
                if (typeof XLSX === 'undefined') {
                    showStatus("Biblioteca XLSX não carregada. Tentando exportar CSV...");
                    exportCSV();
                    return;
                }
                
                // Criar workbook
                var wb = XLSX.utils.book_new();
                
                // Planilha de dados brutos
                var excelData = [];
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var date = new Date(item.timestamp);
                    
                    excelData.push({
                        'Projeto': currentProject,
                        'Data/Hora': date.toLocaleString(),
                        'Espécie': item.species,
                        'Abundância': item.abundance,
                        'Latitude': item.latitude,
                        'Longitude': item.longitude,
                        'Precisão (m)': item.accuracy || 0,
                        'Método': item.manual ? "Manual" : "GPS",
                        'Observação': item.observation
                    });
                }
                var ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, "Dados");
                
                // Análises descritivas por espécie
                const stats = calculateStats(data);
                const statsData = [];
                for (let species in stats) {
                    statsData.push({
                        'Espécie': species,
                        'Abundância Total': stats[species].sum,
                        'Número de Registros': stats[species].count,
                        'Abundância Média': stats[species].mean.toFixed(2),
                        'Abundância Mediana': stats[species].median.toFixed(2),
                        'Abundância Mínima': stats[species].min,
                        'Abundância Máxima': stats[species].max,
                        'Desvio Padrão': calculateStdDev(stats[species].values).toFixed(2),
                        'Frequência Relativa (%)': ((stats[species].count / data.length) * 100).toFixed(2)
                    });
                }
                var wsStats = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, wsStats, "Análise por Espécie");
                
                // Métricas de biodiversidade
                const biodivMetrics = calculateBiodiversityMetrics(data);
                const metricsData = [
                    { 'Métrica': 'Riqueza de Espécies', 'Valor': biodivMetrics.richness },
                    { 'Métrica': 'Índice de Shannon (H\')', 'Valor': biodivMetrics.shannon.toFixed(4) },
                    { 'Métrica': 'Equitabilidade de Pielou (J\')', 'Valor': biodivMetrics.evenness.toFixed(4) },
                    { 'Métrica': 'Índice de Simpson (D)', 'Valor': biodivMetrics.simpson.toFixed(4) },
                    { 'Métrica': 'Total de Indivíduos', 'Valor': biodivMetrics.totalIndividuals },
                    { 'Métrica': 'Número Total de Registros', 'Valor': data.length }
                ];
                var wsMetrics = XLSX.utils.json_to_sheet(metricsData);
                XLSX.utils.book_append_sheet(wb, wsMetrics, "Métricas de Biodiversidade");
                
                // Análise temporal
                const temporalData = calculateTemporalAnalysis(data);
                var wsTemp = XLSX.utils.json_to_sheet(temporalData);
                XLSX.utils.book_append_sheet(wb, wsTemp, "Análise Temporal");
                
                // Gerar arquivo e fazer download
                var filename = currentProject + "_dados_" + 
                               new Date().toISOString().split('T')[0] + ".xlsx";
                
                XLSX.writeFile(wb, filename);
                showStatus("Arquivo Excel exportado com sucesso!");
                
            } catch (e) {
                showStatus("ERRO ao exportar Excel: " + e.message + ". Tentando CSV...");
                logDiagnostic("Erro Excel: " + e.message);
                setTimeout(exportCSV, 1000);
            }
        }

        // Função para calcular desvio padrão
        function calculateStdDev(values) {
            const mean = values.reduce((a, b) => a + b) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - mean, 2));
            const variance = squareDiffs.reduce((a, b) => a + b) / values.length;
            return Math.sqrt(variance);
        }

        // Função para calcular métricas de biodiversidade
        function calculateBiodiversityMetrics(data) {
            // Contagem por espécie
            const speciesCounts = {};
            let totalIndividuals = 0;
            
            data.forEach(item => {
                if (!speciesCounts[item.species]) {
                    speciesCounts[item.species] = 0;
                }
                speciesCounts[item.species] += item.abundance;
                totalIndividuals += item.abundance;
            });
            
            const richness = Object.keys(speciesCounts).length;
            
            // Índice de Shannon
            let shannon = 0;
            for (let species in speciesCounts) {
                const pi = speciesCounts[species] / totalIndividuals;
                shannon -= pi * Math.log(pi);
            }
            
            // Equitabilidade de Pielou
            const maxShannon = Math.log(richness);
            const evenness = shannon / maxShannon;
            
            // Índice de Simpson
            let simpson = 0;
            for (let species in speciesCounts) {
                const pi = speciesCounts[species] / totalIndividuals;
                simpson += pi * pi;
            }
            
            return {
                richness,
                shannon,
                evenness,
                simpson,
                totalIndividuals
            };
        }

        // Função para análise temporal
        function calculateTemporalAnalysis(data) {
            const temporalData = [];
            const dateGroups = {};
            
            // Agrupar dados por data
            data.forEach(item => {
                const date = new Date(item.timestamp).toLocaleDateString();
                if (!dateGroups[date]) {
                    dateGroups[date] = {
                        registros: 0,
                        especies: new Set(),
                        abundanciaTotal: 0
                    };
                }
                dateGroups[date].registros++;
                dateGroups[date].especies.add(item.species);
                dateGroups[date].abundanciaTotal += item.abundance;
            });
            
            // Converter para formato de tabela
            for (let date in dateGroups) {
                temporalData.push({
                    'Data': date,
                    'Número de Registros': dateGroups[date].registros,
                    'Número de Espécies': dateGroups[date].especies.size,
                    'Abundância Total': dateGroups[date].abundanciaTotal,
                    'Média de Indivíduos por Registro': (dateGroups[date].abundanciaTotal / dateGroups[date].registros).toFixed(2)
                });
            }
            
            return temporalData;
        }
        
        // Exportar para CSV (fallback se Excel falhar)
        function exportCSV() {
            if (!currentProject) return;
            
            var data = projects[currentProject].data;
            if (data.length === 0) return;
            
            try {
                var csv = "Data/Hora,Espécie,Abundância,Latitude,Longitude,Precisão (m),Método,Observação\n";
                
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var date = new Date(item.timestamp).toLocaleString();
                    csv += date + "," + 
                           item.species + "," + 
                           item.abundance + "," + 
                           item.latitude + "," + 
                           item.longitude + "," + 
                           (item.accuracy || 0) + "," + 
                           (item.manual ? "Manual" : "GPS") + ",\"" + 
                           item.observation + "\"\n";
                }
                
                var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
                var link = document.createElement("a");
                var url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                link.setAttribute("download", currentProject + "_dados.csv");
                link.style.visibility = "hidden";
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus("Dados exportados como CSV (fallback)");
            } catch (e) {
                showStatus("ERRO na exportação de dados: " + e.message);
            }
        }

        // Verificar suporte à geolocalização
        function checkGeolocationSupport() {
            if (!navigator.geolocation) {
                logDiagnostic("Geolocalização não suportada neste navegador");
                showStatus("Seu navegador não suporta geolocalização");
                return false;
            }
            
            logDiagnostic("Geolocalização suportada");
            return true;
        }

        // Verificar se a biblioteca XLSX está disponível e carregá-la se necessário
        function checkAndLoadXLSX() {
            if (typeof XLSX === 'undefined') {
                console.log("Biblioteca XLSX não encontrada, tentando carregar...");
                
                var script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
                script.async = true;
                script.onload = function() {
                    console.log("Biblioteca XLSX carregada com sucesso!");
                    logDiagnostic("Biblioteca XLSX carregada com sucesso!");
                };
                script.onerror = function() {
                    console.error("Falha ao carregar biblioteca XLSX");
                    logDiagnostic("Falha ao carregar biblioteca XLSX");
                };
                
                document.head.appendChild(script);
            } else {
                console.log("Biblioteca XLSX já está disponível");
            }
        }

        // Chamar a função de verificação após o carregamento da página
        window.addEventListener('load', checkAndLoadXLSX);

        // Função para inicializar o autocomplete
        function initAutocomplete() {
            // Autocomplete para o formulário principal
            speciesInputEl.addEventListener('input', handleInput);
            speciesInputEl.addEventListener('focus', handleFocus);
            speciesInputEl.addEventListener('keydown', handleKeydown);

            // Autocomplete para o modal de edição
            var editSpeciesInputEl = document.getElementById('editSpeciesInput');
            var editSpeciesSuggestionsEl = document.getElementById('editSpeciesSuggestions');
            
            if (editSpeciesInputEl && editSpeciesSuggestionsEl) {
                editSpeciesInputEl.addEventListener('input', function(e) {
                    handleInput.call(this, e, editSpeciesSuggestionsEl);
                });
                
                editSpeciesInputEl.addEventListener('focus', function(e) {
                    handleFocus.call(this, e, editSpeciesSuggestionsEl);
                });
                
                editSpeciesInputEl.addEventListener('keydown', function(e) {
                    handleKeydown.call(this, e, editSpeciesSuggestionsEl);
                });
                
                // Fechar sugestões ao clicar fora
                document.addEventListener('click', function(e) {
                    if (!editSpeciesInputEl.contains(e.target) && !editSpeciesSuggestionsEl.contains(e.target)) {
                        editSpeciesSuggestionsEl.style.display = 'none';
                    }
                });
            }

            // Fechar sugestões ao clicar fora (formulário principal)
            document.addEventListener('click', function(e) {
                if (!speciesInputEl.contains(e.target) && !speciesSuggestionsEl.contains(e.target)) {
                    speciesSuggestionsEl.style.display = 'none';
                }
            });
        }

        // Função para lidar com input
        function handleInput(e, suggestionsEl = speciesSuggestionsEl) {
            const query = this.value.toLowerCase();
            if (query.length < 1) {
                suggestionsEl.style.display = 'none';
                return;
            }

            const suggestions = speciesList.filter(species => 
                species.toLowerCase().includes(query)
            );

            if (suggestions.length > 0) {
                showSuggestions(suggestions, query, suggestionsEl, this);
            } else {
                suggestionsEl.style.display = 'none';
            }
        }

        // Função para lidar com focus
        function handleFocus(e, suggestionsEl = speciesSuggestionsEl) {
            if (this.value.length > 0) {
                const query = this.value.toLowerCase();
                const suggestions = speciesList.filter(species => 
                    species.toLowerCase().includes(query)
                );
                if (suggestions.length > 0) {
                    showSuggestions(suggestions, query, suggestionsEl, this);
                }
            }
        }

        // Função para lidar com keydown
        function handleKeydown(e, suggestionsEl = speciesSuggestionsEl) {
            const suggestions = suggestionsEl.children;
            let selectedIndex = -1;

            for (let i = 0; i < suggestions.length; i++) {
                if (suggestions[i].classList.contains('selected')) {
                    selectedIndex = i;
                    break;
                }
            }

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (suggestionsEl.style.display === 'none') {
                        const query = this.value.toLowerCase();
                        const suggestions = speciesList.filter(species => 
                            species.toLowerCase().includes(query)
                        );
                        if (suggestions.length > 0) {
                            showSuggestions(suggestions, query, suggestionsEl, this);
                        }
                    } else {
                        if (selectedIndex < suggestions.length - 1) {
                            if (selectedIndex >= 0) {
                                suggestions[selectedIndex].classList.remove('selected');
                            }
                            suggestions[selectedIndex + 1].classList.add('selected');
                            suggestions[selectedIndex + 1].scrollIntoView({ block: 'nearest' });
                        }
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (selectedIndex > 0) {
                        suggestions[selectedIndex].classList.remove('selected');
                        suggestions[selectedIndex - 1].classList.add('selected');
                        suggestions[selectedIndex - 1].scrollIntoView({ block: 'nearest' });
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0) {
                        selectSpecies(suggestions[selectedIndex].textContent, this, suggestionsEl);
                    }
                    break;
                case 'Escape':
                    suggestionsEl.style.display = 'none';
                    break;
            }
        }

        // Função para mostrar sugestões
        function showSuggestions(suggestions, query, suggestionsEl = speciesSuggestionsEl, inputEl = speciesInputEl) {
            suggestionsEl.innerHTML = '';
            suggestions.forEach(species => {
                const div = document.createElement('div');
                div.className = 'species-suggestion';
                
                // Destacar parte do texto que corresponde à busca
                const index = species.toLowerCase().indexOf(query.toLowerCase());
                if (index >= 0) {
                    const before = species.substring(0, index);
                    const match = species.substring(index, index + query.length);
                    const after = species.substring(index + query.length);
                    div.innerHTML = before + '<span class="highlight">' + match + '</span>' + after;
                } else {
                    div.textContent = species;
                }

                div.addEventListener('click', function() {
                    selectSpecies(species, inputEl, suggestionsEl);
                });
                suggestionsEl.appendChild(div);
            });
            suggestionsEl.style.display = 'block';
        }

        // Função para selecionar uma espécie
        function selectSpecies(species, inputEl = speciesInputEl, suggestionsEl = speciesSuggestionsEl) {
            inputEl.value = species;
            if (inputEl === speciesInputEl) {
                selectedSpecies = species;
            }
            suggestionsEl.style.display = 'none';
        }

        // Função para alternar cards
        function toggleCard(cardId) {
            var content = document.getElementById(cardId);
            if (content.style.display === "block") {
                content.style.display = "none";
            } else {
                content.style.display = "block";
            }
        }

        // Iniciar após o carregamento
        window.onload = init;

        // Função para calcular estatísticas
        function calculateStats(data) {
            let stats = {};
            
            // Agrupar dados por espécie
            data.forEach(item => {
                if (!stats[item.species]) {
                    stats[item.species] = {
                        values: [],
                        count: 0,
                        sum: 0,
                        mean: 0,
                        median: 0,
                        min: Infinity,
                        max: -Infinity,
                        q1: 0,
                        q3: 0
                    };
                }
                
                stats[item.species].values.push(item.abundance);
                stats[item.species].count++;
                stats[item.species].sum += item.abundance;
                stats[item.species].min = Math.min(stats[item.species].min, item.abundance);
                stats[item.species].max = Math.max(stats[item.species].max, item.abundance);
            });
            
            // Calcular estatísticas para cada espécie
            for (let species in stats) {
                let values = stats[species].values.sort((a, b) => a - b);
                stats[species].mean = stats[species].sum / stats[species].count;
                stats[species].median = calculateMedian(values);
                stats[species].q1 = calculateQuantile(values, 0.25);
                stats[species].q3 = calculateQuantile(values, 0.75);
            }
            
            return stats;
        }
        
        // Função para calcular mediana
        function calculateMedian(values) {
            const mid = Math.floor(values.length / 2);
            return values.length % 2 === 0 ? (values[mid - 1] + values[mid]) / 2 : values[mid];
        }
        
        // Função para calcular quartis
        function calculateQuantile(values, q) {
            const pos = (values.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            if (values[base + 1] !== undefined) {
                return values[base] + rest * (values[base + 1] - values[base]);
            } else {
                return values[base];
            }
        }
        
        // Função para atualizar visualizações
        function updateVisualizations() {
            if (!currentProject || !projects[currentProject].data.length) {
                document.getElementById('statsCard').innerHTML = '<p>Nenhum dado disponível para análise</p>';
                return;
            }
            
            const stats = calculateStats(projects[currentProject].data);
            updateStatsTable(stats);
            updateBoxplot(stats);
        }
        
        // Função para atualizar tabela de estatísticas
        function updateStatsTable(stats) {
            const table = document.createElement('table');
            table.className = 'stats-table';
            
            // Cabeçalho
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Espécie</th>
                    <th>Contagem</th>
                    <th>Média</th>
                    <th>Mediana</th>
                    <th>Mínimo</th>
                    <th>Máximo</th>
                    <th>Q1</th>
                    <th>Q3</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // Corpo da tabela
            const tbody = document.createElement('tbody');
            for (let species in stats) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${species}</td>
                    <td>${stats[species].count}</td>
                    <td>${stats[species].mean.toFixed(2)}</td>
                    <td>${stats[species].median.toFixed(2)}</td>
                    <td>${stats[species].min}</td>
                    <td>${stats[species].max}</td>
                    <td>${stats[species].q1.toFixed(2)}</td>
                    <td>${stats[species].q3.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
            
            document.getElementById('statsTable').innerHTML = '';
            document.getElementById('statsTable').appendChild(table);
        }
        
        // Função para atualizar boxplot
        function updateBoxplot(stats) {
            const ctx = document.getElementById('boxplotChart').getContext('2d');
            
            // Destruir gráfico anterior se existir
            if (window.boxplotChart) {
                window.boxplotChart.destroy();
            }
            
            const datasets = [];
            const labels = Object.keys(stats);
            
            // Preparar dados para o boxplot
            const data = labels.map(species => ({
                min: stats[species].min,
                q1: stats[species].q1,
                median: stats[species].median,
                q3: stats[species].q3,
                max: stats[species].max
            }));
            
            window.boxplotChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Abundância',
                        data: data.map(d => [d.min, d.q1, d.median, d.q3, d.max]),
                        backgroundColor: 'rgba(66, 133, 244, 0.5)',
                        borderColor: 'rgb(66, 133, 244)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuição de Abundância por Espécie'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Abundância'
                            }
                        }
                    }
                }
            });
        }

        // Função para abrir o modal de exportação múltipla
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';

            // Criar checkboxes para cada projeto
            for (let projectName in projects) {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'project_' + projectName;
                checkbox.value = projectName;
                checkbox.style.marginRight = '10px';
                
                const label = document.createElement('label');
                label.htmlFor = 'project_' + projectName;
                label.textContent = projectName;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                projectList.appendChild(div);
            }

            modal.style.display = 'block';
        }

        // Função para fechar o modal de exportação
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // Função para exportar múltiplos projetos
        function exportMultipleProjects() {
            const selectedProjects = [];
            const checkboxes = document.querySelectorAll('#projectList input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedProjects.push(checkbox.value);
                }
            });

            if (selectedProjects.length === 0) {
                showStatus("Selecione pelo menos um projeto");
                return;
            }

            try {
                if (typeof XLSX === 'undefined') {
                    showStatus("Biblioteca XLSX não carregada. Tentando exportar CSV...");
                    return;
                }

                // Criar workbook
                const wb = XLSX.utils.book_new();
                
                // Combinar dados de todos os projetos selecionados
                const allData = [];
                selectedProjects.forEach(projectName => {
                    const projectData = projects[projectName].data;
                    projectData.forEach(item => {
                        const date = new Date(item.timestamp);
                        allData.push({
                            'Projeto': projectName,
                            'Data/Hora': date.toLocaleString(),
                            'Espécie': item.species,
                            'Abundância': item.abundance,
                            'Latitude': item.latitude,
                            'Longitude': item.longitude,
                            'Precisão (m)': item.accuracy || 0,
                            'Método': item.manual ? "Manual" : "GPS",
                            'Observação': item.observation
                        });
                    });
                });

                // Planilha de dados brutos
                const ws = XLSX.utils.json_to_sheet(allData);
                XLSX.utils.book_append_sheet(wb, ws, "Dados");

                // Análises descritivas por espécie (considerando todos os projetos)
                const stats = calculateStats(allData.map(item => ({
                    species: item.Espécie,
                    abundance: item.Abundância
                })));
                const statsData = [];
                for (let species in stats) {
                    statsData.push({
                        'Espécie': species,
                        'Abundância Total': stats[species].sum,
                        'Número de Registros': stats[species].count,
                        'Abundância Média': stats[species].mean.toFixed(2),
                        'Abundância Mediana': stats[species].median.toFixed(2),
                        'Abundância Mínima': stats[species].min,
                        'Abundância Máxima': stats[species].max,
                        'Desvio Padrão': calculateStdDev(stats[species].values).toFixed(2),
                        'Frequência Relativa (%)': ((stats[species].count / allData.length) * 100).toFixed(2)
                    });
                }
                const wsStats = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, wsStats, "Análise por Espécie");

                // Métricas de biodiversidade (total e por projeto)
                const biodivMetrics = calculateBiodiversityMetrics(allData.map(item => ({
                    species: item.Espécie,
                    abundance: item.Abundância
                })));
                const metricsData = [
                    { 'Projeto': 'TOTAL', 'Métrica': 'Riqueza de Espécies', 'Valor': biodivMetrics.richness },
                    { 'Projeto': 'TOTAL', 'Métrica': 'Índice de Shannon (H\')', 'Valor': biodivMetrics.shannon.toFixed(4) },
                    { 'Projeto': 'TOTAL', 'Métrica': 'Equitabilidade de Pielou (J\')', 'Valor': biodivMetrics.evenness.toFixed(4) },
                    { 'Projeto': 'TOTAL', 'Métrica': 'Índice de Simpson (D)', 'Valor': biodivMetrics.simpson.toFixed(4) },
                    { 'Projeto': 'TOTAL', 'Métrica': 'Total de Indivíduos', 'Valor': biodivMetrics.totalIndividuals },
                    { 'Projeto': 'TOTAL', 'Métrica': 'Número Total de Registros', 'Valor': allData.length }
                ];

                // Adicionar métricas por projeto
                selectedProjects.forEach(projectName => {
                    const projectData = allData.filter(item => item.Projeto === projectName)
                        .map(item => ({
                            species: item.Espécie,
                            abundance: item.Abundância
                        }));
                    const projectMetrics = calculateBiodiversityMetrics(projectData);
                    metricsData.push(
                        { 'Projeto': projectName, 'Métrica': 'Riqueza de Espécies', 'Valor': projectMetrics.richness },
                        { 'Projeto': projectName, 'Métrica': 'Índice de Shannon (H\')', 'Valor': projectMetrics.shannon.toFixed(4) },
                        { 'Projeto': projectName, 'Métrica': 'Equitabilidade de Pielou (J\')', 'Valor': projectMetrics.evenness.toFixed(4) },
                        { 'Projeto': projectName, 'Métrica': 'Índice de Simpson (D)', 'Valor': projectMetrics.simpson.toFixed(4) },
                        { 'Projeto': projectName, 'Métrica': 'Total de Indivíduos', 'Valor': projectMetrics.totalIndividuals },
                        { 'Projeto': projectName, 'Métrica': 'Número Total de Registros', 'Valor': projectData.length }
                    );
                });

                const wsMetrics = XLSX.utils.json_to_sheet(metricsData);
                XLSX.utils.book_append_sheet(wb, wsMetrics, "Métricas de Biodiversidade");

                // Análise temporal
                const temporalData = calculateTemporalAnalysis(allData.map(item => ({
                    species: item.Espécie,
                    abundance: item.Abundância,
                    timestamp: new Date(item['Data/Hora']).toISOString()
                })));
                const wsTemp = XLSX.utils.json_to_sheet(temporalData);
                XLSX.utils.book_append_sheet(wb, wsTemp, "Análise Temporal");

                // Gerar arquivo e fazer download
                const filename = "BioPlan_multiplos_projetos_" + 
                               new Date().toISOString().split('T')[0] + ".xlsx";
                
                XLSX.writeFile(wb, filename);
                showStatus("Arquivo Excel exportado com sucesso!");
                closeExportModal();

            } catch (e) {
                showStatus("ERRO ao exportar Excel: " + e.message);
                console.error(e);
            }
        }
    </script>
</body>
</html> 