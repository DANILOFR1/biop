<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioPlan</title>
    <!-- SheetJS para exportação em Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-collapsible {
            margin-bottom: 5px;
        }
        .card-content {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
            margin-top: -5px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .card-header:hover {
            background-color: #f8f9fa;
        }
        .card-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .section-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4285f4;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .green-btn {
            background-color: #0f9d58;
        }
        .orange-btn {
            background-color: #ff9800;
        }
        .red-btn {
            background-color: #ea4335;
        }
        .item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .coords {
            color: #666;
            font-size: 14px;
        }
        .notes {
            margin: 5px 0;
        }
        .status {
            margin-top: 10px;
            padding: 8px;
            background-color: #e8f0fe;
            border-radius: 4px;
            text-align: center;
            display: none;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .export-btn {
            width: auto;
            margin-left: 10px;
        }
        .manual-coords {
            display: none;
            background-color: #fffde7;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .coord-input {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .coord-input input {
            margin-bottom: 0;
        }
        .helper-text {
            color: #666;
            font-size: 12px;
            margin-top: -5px;
            margin-bottom: 10px;
        }
        .location-help {
            display: none;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .location-help ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .location-help li {
            margin-bottom: 5px;
        }
        .info-icon {
            color: white;
            background: #4285f4;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-block;
            text-align: center;
            line-height: 18px;
            font-size: 14px;
            margin-right: 5px;
            font-weight: bold;
        }
        .diagnostic {
            display: none;
            background-color: #fffde7;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ffd54f;
        }
        .install-button {
            display: none;
            position: fixed;
            bottom: 70px; /* Ajustado para dar espaço ao footer */
            left: 50%;
            transform: translateX(-50%);
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .action-buttons button {
            padding: 3px 8px;
            font-size: 12px;
            margin-bottom: 0;
        }
        .edit-mode {
            background-color: #fff3e0;
            border: 1px dashed #ff9800;
        }
        .species-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .species-manager {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 4px;
            display: none;
        }
        .species-list {
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 5px;
            background-color: white;
        }
        .species-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .import-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #cce5ff;
        }
        .import-area {
            background-color: white;
            border: 1px solid #cce5ff;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        .file-input-container input[type="file"] {
            padding: 8px;
            border: 1px dashed #4285f4;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .species-select-container {
            position: relative;
            margin-bottom: 10px;
        }
        .species-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .species-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .species-suggestion {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .species-suggestion:hover {
            background-color: #f5f5f5;
        }
        .species-suggestion.selected {
            background-color: #e3f2fd;
        }
        .highlight {
            background-color: #fff9c4;
            padding: 0 2px;
        }
        .footer {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .footer p {
            margin: 5px 0;
        }
        .footer .citation {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        .footer .donation {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
        }
        .footer .pix-key {
            font-family: monospace;
            background-color: #fff;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            display: inline-block;
            margin-top: 5px;
        }
        .pwa-install-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 14px;
        }
        .install-instructions {
            background-color: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .install-instructions p {
            margin: 8px 0;
        }
        .helper-text {
            color: #0f9d58;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BioPlan</h1>
        
        <div id="status" class="status"></div>
        
        <!-- Projetos -->
        <div class="card">
            <div class="section-title">Projetos</div>
            <input type="text" id="projectName" placeholder="Nome do novo projeto">
            <button id="createBtn">Criar Projeto</button>
            <select id="projectSelect">
                <option value="">Selecione um projeto</option>
            </select>
            <button id="deleteProjectBtn" class="red-btn">Excluir Projeto</button>
        </div>

        <!-- Coleta -->
        <div class="card">
            <div class="section-title">Coleta de Dados</div>
            <label>Espécie:</label>
            <div class="species-select-container">
                <input type="text" id="speciesInput" class="species-input" placeholder="Digite para buscar espécies...">
                <div id="speciesSuggestions" class="species-suggestions"></div>
            </div>
            <label>Abundância:</label>
            <input type="number" id="abundance" placeholder="Quantidade">
            <label>Observação:</label>
            <textarea id="notes" rows="3"></textarea>
            <button id="locationBtn" class="green-btn">Capturar Localização</button>
            <button id="googleMapsBtn" class="green-btn">Localização via Google Maps</button>
            <div id="mapsContainer" class="maps-container" style="display: none;">
                <div class="maps-info">
                    <p><strong>Para obter coordenadas do Google Maps:</strong></p>
                    <ol>
                        <li>Abra o <a href="https://maps.google.com" target="_blank">Google Maps</a></li>
                        <li>Navegue até o local desejado</li>
                        <li>Clique e segure na localização para obter as coordenadas</li>
                        <li>Copie as coordenadas e insira-as abaixo</li>
                    </ol>
                </div>
                <div class="coord-input">
                    <input type="number" id="mapsLatInput" placeholder="Latitude" step="0.000001">
                    <input type="number" id="mapsLngInput" placeholder="Longitude" step="0.000001">
                </div>
                <div class="maps-buttons">
                    <button id="saveMapsCoords" class="green-btn">Salvar Coordenadas</button>
                    <button id="closeMapsBtn" class="red-btn">Cancelar</button>
                </div>
            </div>
            <div id="diagnostic" class="diagnostic"></div>
            
            <div id="locationHelp" class="location-help">
                <p><strong>Problema ao acessar localização.</strong></p>
                <p>Para permitir acesso à localização:</p>
                <ul>
                    <li>Nas configurações do Chrome: "Configurações do site" → "Localização" → Permitir</li>
                    <li>Nas configurações do Android: "Aplicativos" → "Chrome" → "Permissões" → "Localização" → Permitir</li>
                    <li>Ative o GPS do seu dispositivo</li>
                    <li>Tente usar outro navegador como Firefox</li>
                </ul>
                <button id="tryAgainBtn" class="green-btn">Tentar Novamente</button>
                <button id="tryAlternativeBtn" class="orange-btn">Usar Método Alternativo</button>
                <button id="closeHelpBtn" class="red-btn">Fechar Ajuda</button>
            </div>
            
            <button id="manualBtn" class="orange-btn">Inserir Coordenadas Manualmente</button>
            
            <div id="manualCoords" class="manual-coords">
                <div class="coord-input">
                    <input type="number" id="latInput" placeholder="Latitude" step="0.000001">
                    <input type="number" id="lngInput" placeholder="Longitude" step="0.000001">
                </div>
                <div class="helper-text">Exemplo: Latitude -23.550520, Longitude -46.633308</div>
                <button id="saveCoords" class="green-btn">Salvar Coordenadas</button>
            </div>
            
            <button id="saveBtn">Salvar Dados</button>
        </div>

        <!-- Gerenciamento -->
        <div class="card-collapsible">
            <div class="card-header" onclick="toggleCard('speciesCard')">
                <h3>Gerenciar Espécies</h3>
                <button class="orange-btn export-btn">Mostrar/Ocultar</button>
            </div>
            <div id="speciesCard" class="card-content">
                <!-- Adicionar espécies manualmente -->
                <div class="manual-add-section">
                    <h4 style="margin: 0 0 10px 0;">Adicionar Espécie</h4>
                    <input type="text" id="newSpecies" placeholder="Nome da nova espécie">
                    <button id="addSpeciesBtn" class="green-btn">Adicionar Espécie</button>
                </div>

                <!-- Lista de espécies -->
                <div class="species-list" id="speciesList">
                    <!-- Espécies serão adicionadas aqui -->
                </div>

                <!-- Seção de importação -->
                <div class="import-section">
                    <h4 style="margin: 10px 0;">Importar Espécies</h4>
                    <div class="import-area">
                        <p class="helper-text">Selecione um arquivo Excel (.xlsx, .xls), CSV ou TXT com nomes de espécies (um por linha).</p>
                        <div class="file-input-container">
                            <input type="file" id="importExcel" accept=".xlsx, .xls, .csv, .txt">
                            <button id="importExcelBtn" class="green-btn">Importar Espécies</button>
                        </div>
                        <button id="testXLSXBtn" class="orange-btn" style="margin-top: 5px;">Verificar Biblioteca XLSX</button>
                        <div id="importDiagnostic" class="diagnostic"></div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button id="importTxtBtn" class="orange-btn">Importar de TXT (Método Alternativo)</button>
                        <p class="helper-text">Use esta opção se a importação normal não funcionar.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados Coletados -->
        <div class="card-collapsible">
            <div class="card-header" onclick="toggleCard('dataCard')">
                <h3>Dados Coletados</h3>
                <div>
                    <button id="exportBtn" class="green-btn export-btn">Exportar Excel</button>
                    <button class="orange-btn export-btn">Mostrar/Ocultar</button>
                </div>
            </div>
            <div id="dataCard" class="card-content">
                <div id="dataList"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="citation">
                <p><strong>Citar como:</strong></p>
                <p>RANGEL, Danilo Freitas. WebApp BioPlan. 2025. Disponível em: &lt;https://danilofr1.github.io/biop/&gt;. Acesso em: DATA MES. ANO.</p>
                <p><strong>Contato:</strong> drangel@unifesp.br</p>
            </div>
            <div class="donation">
                <p><strong>Se o App foi útil para você, faça uma doação por Pix:</strong></p>
                <p>Chave aleatória: <span class="pix-key">3c37c492-cebe-4927-b7db-68b004b67c99</span></p>
            </div>
            <div class="pwa-install-info">
                <p><strong>📱 Instale o BioPlan no seu dispositivo:</strong></p>
                <div class="install-instructions">
                    <p><strong>Samsung:</strong> Use o Samsung Internet e toque em Menu (☰) → "Adicionar página à" → "Tela inicial" → "Instalar"</p>
                    <p><strong>Outros:</strong> No Chrome, toque em Menu (⋮) → "Adicionar à tela inicial"</p>
                    <p class="helper-text">Após instalado, o app funcionará offline!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de edição -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 90%; width: 500px; margin: 20px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top: 0;">Editar Registro</h3>
            
            <div style="margin-bottom: 15px;">
                <label>Espécie:</label>
                <div class="species-select-container">
                    <input type="text" id="editSpeciesInput" class="species-input" placeholder="Digite para buscar espécies...">
                    <div id="editSpeciesSuggestions" class="species-suggestions"></div>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Abundância:</label>
                <input type="number" id="editAbundance" placeholder="Quantidade">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Observação:</label>
                <textarea id="editNotes" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>Coordenadas:</label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <input type="number" id="editLat" placeholder="Latitude" step="0.000001" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="number" id="editLng" placeholder="Longitude" step="0.000001" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancelEditBtn" style="background-color: #9e9e9e; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button id="saveEditBtn" style="background-color: #0f9d58; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis
        var projects = {};
        var currentProject = null;
        var currentLocation = null;
        var watchId = null;
        var locationUpdateCount = 0;
        var speciesList = []; // Será preenchido a partir do localStorage

        // Elementos 
        var statusEl = document.getElementById("status");
        var projectNameEl = document.getElementById("projectName");
        var projectSelectEl = document.getElementById("projectSelect");
        var createBtnEl = document.getElementById("createBtn");
        var deleteProjectBtnEl = document.getElementById("deleteProjectBtn");
        var locationBtnEl = document.getElementById("locationBtn");
        var googleMapsBtnEl = document.getElementById("googleMapsBtn");
        var mapsContainerEl = document.getElementById("mapsContainer");
        var mapsLatInputEl = document.getElementById("mapsLatInput");
        var mapsLngInputEl = document.getElementById("mapsLngInput");
        var saveMapsCoordsEl = document.getElementById("saveMapsCoords");
        var closeMapsBtn = document.getElementById("closeMapsBtn");
        var diagnosticEl = document.getElementById("diagnostic");
        var locationHelpEl = document.getElementById("locationHelp");
        var tryAgainBtnEl = document.getElementById("tryAgainBtn");
        var tryAlternativeBtnEl = document.getElementById("tryAlternativeBtn");
        var closeHelpBtnEl = document.getElementById("closeHelpBtn");
        var manualBtnEl = document.getElementById("manualBtn");
        var manualCoordsEl = document.getElementById("manualCoords");
        var latInputEl = document.getElementById("latInput");
        var lngInputEl = document.getElementById("lngInput");
        var saveCoordsEl = document.getElementById("saveCoords");
        var speciesSelectEl = document.getElementById("speciesSelect");
        var abundanceEl = document.getElementById("abundance");
        var notesEl = document.getElementById("notes");
        var saveBtnEl = document.getElementById("saveBtn");
        var exportBtnEl = document.getElementById("exportBtn");
        var dataListEl = document.getElementById("dataList");
        var speciesManagerEl = document.getElementById("speciesManager");
        var newSpeciesEl = document.getElementById("newSpecies");
        var addSpeciesBtnEl = document.getElementById("addSpeciesBtn");
        var speciesListEl = document.getElementById("speciesList");
        var importExcelEl = document.getElementById("importExcel");
        var importExcelBtnEl = document.getElementById("importExcelBtn");
        var testXLSXBtnEl = document.getElementById("testXLSXBtn");
        var importTxtBtnEl = document.getElementById("importTxtBtn");

        // Elementos adicionados para autocomplete
        var speciesInputEl = document.getElementById("speciesInput");
        var speciesSuggestionsEl = document.getElementById("speciesSuggestions");
        var selectedSpecies = "";

        // Inicialização
        function init() {
            showStatus("Iniciando aplicativo...");
            
            // Carregar projetos
            try {
                var savedData = window.localStorage.getItem("bioProjects");
                if (savedData) {
                    projects = JSON.parse(savedData);
                    updateProjectList();
                    showStatus("Dados carregados com sucesso!");
                } else {
                    showStatus("Nenhum projeto encontrado. Crie um novo.");
                }
            } catch (e) {
                showStatus("ERRO ao carregar dados: " + e.message);
            }
            
            // Carregar espécies
            loadSpecies();
            
            // Configurar eventos
            createBtnEl.onclick = createProject;
            deleteProjectBtnEl.onclick = deleteProject;
            projectSelectEl.onchange = loadProject;
            locationBtnEl.onclick = captureLocation;
            googleMapsBtnEl.onclick = toggleGoogleMaps;
            saveMapsCoordsEl.onclick = saveMapsCoords;
            closeMapsBtn.onclick = function() {
                mapsContainerEl.style.display = "none";
            };
            tryAgainBtnEl.onclick = function() {
                locationHelpEl.style.display = "none";
                captureLocation();
            };
            tryAlternativeBtnEl.onclick = function() {
                locationHelpEl.style.display = "none";
                useAlternativeLocation();
            };
            closeHelpBtnEl.onclick = function() {
                locationHelpEl.style.display = "none";
            };
            manualBtnEl.onclick = toggleManualCoords;
            saveCoordsEl.onclick = saveManualCoords;
            saveBtnEl.onclick = saveData;
            exportBtnEl.onclick = exportExcel;
            
            // Eventos de gerenciamento de espécies
            if (addSpeciesBtnEl) {
                addSpeciesBtnEl.onclick = addSpecies;
            }
            
            // Eventos do modal de edição
            var saveEditBtn = document.getElementById('saveEditBtn');
            var cancelEditBtn = document.getElementById('cancelEditBtn');
            if (saveEditBtn) {
                saveEditBtn.addEventListener('click', saveEdit);
            }
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    var editModal = document.getElementById('editModal');
                    if (editModal) {
                        editModal.style.display = 'none';
                    }
                });
            }
            
            // Verificar suporte à geolocalização
            checkGeolocationSupport();

            // Evento para importar espécies de Excel/CSV/TXT
            importExcelBtnEl.onclick = function() {
                // Limpar mensagens anteriores
                var importDiagnosticEl = document.getElementById('importDiagnostic');
                importDiagnosticEl.innerHTML = "";
                importDiagnosticEl.style.display = "block";
                
                logImportDiagnostic("Iniciando importação de espécies");
                
                // Verificar se um arquivo foi selecionado
                var fileInput = document.getElementById('importExcel');
                if (!fileInput.files.length) {
                    showStatus("Selecione um arquivo primeiro");
                    logImportDiagnostic("Nenhum arquivo selecionado");
                    return;
                }
                
                var file = fileInput.files[0];
                logImportDiagnostic("Arquivo selecionado: " + file.name);
                showStatus("Processando arquivo " + file.name + "...");
                
                // Determinar tipo de arquivo
                var fileName = file.name.toLowerCase();
                var isCSV = fileName.endsWith('.csv');
                var isTXT = fileName.endsWith('.txt');
                var isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                
                logImportDiagnostic("Tipo de arquivo: " + (isExcel ? "Excel" : (isCSV ? "CSV" : "TXT")));
                
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        logImportDiagnostic("Arquivo lido com sucesso");
                        
                        var speciesData = [];
                        
                        if (isCSV || isTXT) {
                            // Processar CSV ou TXT (ambos são tratados como texto)
                            var content = e.target.result;
                            var lines = content.split(/\r?\n/); // Suporta quebras de linha Windows e Unix
                            logImportDiagnostic("Linhas encontradas: " + lines.length);
                            
                            for (var i = 0; i < lines.length; i++) {
                                var line = lines[i].trim();
                                if (line) {
                                    if (isCSV) {
                                        // Para CSV, pegamos apenas a primeira coluna
                                        var parts = line.split(',');
                                        if (parts.length > 0 && parts[0].trim()) {
                                            speciesData.push(parts[0].trim());
                                        }
                                    } else {
                                        // Para TXT, cada linha é uma espécie
                                        speciesData.push(line);
                                    }
                                }
                            }
                        } else if (isExcel) {
                            // Verificar se a biblioteca SheetJS está disponível
                            if (typeof XLSX === 'undefined') {
                                throw new Error("Biblioteca XLSX não disponível. Tente usar um arquivo CSV ou TXT.");
                            }
                            
                            // Processar Excel
                            var data = new Uint8Array(e.target.result);
                            logImportDiagnostic("Lendo arquivo Excel...");
                            
                            try {
                                var workbook = XLSX.read(data, {type: 'array'});
                                logImportDiagnostic("Workbook lido com sucesso");
                                
                                if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                                    throw new Error("Arquivo Excel inválido ou vazio");
                                }
                                
                                var sheetName = workbook.SheetNames[0];
                                logImportDiagnostic("Lendo planilha: " + sheetName);
                                
                                var worksheet = workbook.Sheets[sheetName];
                                var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                                
                                logImportDiagnostic("Dados extraídos: " + jsonData.length + " linhas");
                                
                                // Extrair primeira coluna de cada linha
                                for (var i = 0; i < jsonData.length; i++) {
                                    var row = jsonData[i];
                                    if (row && row.length > 0 && row[0] !== undefined && row[0] !== null) {
                                        var speciesName = row[0].toString().trim();
                                        if (speciesName) {
                                            speciesData.push(speciesName);
                                        }
                                    }
                                }
                            } catch (excelError) {
                                logImportDiagnostic("Erro ao processar Excel: " + excelError.message);
                                throw new Error("Erro ao processar arquivo Excel: " + excelError.message);
                            }
                        } else {
                            throw new Error("Formato de arquivo não suportado. Use Excel, CSV ou TXT.");
                        }
                        
                        // Verificar se temos dados
                        if (speciesData.length === 0) {
                            throw new Error("Nenhuma espécie encontrada no arquivo");
                        }
                        
                        logImportDiagnostic("Espécies encontradas: " + speciesData.length);
                        
                        // Adicionar espécies à lista
                        var addedCount = 0;
                        var duplicateCount = 0;
                        
                        for (var i = 0; i < speciesData.length; i++) {
                            var speciesName = speciesData[i];
                            
                            if (!speciesList.includes(speciesName)) {
                                speciesList.push(speciesName);
                                logImportDiagnostic("Espécie adicionada: " + speciesName);
                                addedCount++;
                            } else {
                                logImportDiagnostic("Espécie duplicada ignorada: " + speciesName);
                                duplicateCount++;
                            }
                        }
                        
                        // Salvar e atualizar a interface
                        window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                        updateSpeciesList();
                        populateSpeciesDropdowns();
                        
                        // Mostrar resultado
                        var message = "Importação concluída: " + addedCount + " espécies adicionadas";
                        if (duplicateCount > 0) {
                            message += ", " + duplicateCount + " duplicadas ignoradas";
                        }
                        
                        showStatus(message);
                        logImportDiagnostic("SUCESSO: " + message);
                        
                        // Limpar o campo de arquivo
                        fileInput.value = "";
                        
                    } catch (error) {
                        logImportDiagnostic("ERRO: " + error.message);
                        showStatus("ERRO ao processar arquivo: " + error.message);
                    }
                };
                
                reader.onerror = function() {
                    logImportDiagnostic("ERRO ao ler o arquivo");
                    showStatus("ERRO ao ler o arquivo");
                };
                
                // Ler o arquivo no formato adequado
                if (isCSV || isTXT) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            };

            // Adicionar evento para testar a biblioteca XLSX
            testXLSXBtnEl.addEventListener('click', function() {
                var importDiagnosticEl = document.getElementById('importDiagnostic');
                importDiagnosticEl.innerHTML = "";
                importDiagnosticEl.style.display = "block";
                
                if (typeof XLSX === 'undefined') {
                    logImportDiagnostic("ERRO: Biblioteca XLSX não está disponível!");
                    showStatus("ERRO: Biblioteca XLSX não está disponível!");
                } else {
                    logImportDiagnostic("SUCESSO: Biblioteca XLSX está disponível (versão: " + (XLSX.version || "desconhecida") + ")");
                    showStatus("Biblioteca XLSX está disponível!");
                    
                    // Criar um workbook simples para testar
                    try {
                        var wb = XLSX.utils.book_new();
                        var ws = XLSX.utils.aoa_to_sheet([["Teste"]]);
                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                        logImportDiagnostic("SUCESSO: Teste de criação de workbook funcionou!");
                    } catch (e) {
                        logImportDiagnostic("ERRO ao testar workbook: " + e.message);
                    }
                }
            });

            // Adicionar evento para importação simplificada de TXT
            importTxtBtnEl.addEventListener('click', function() {
                var importDiagnosticEl = document.getElementById('importDiagnostic');
                importDiagnosticEl.innerHTML = "";
                importDiagnosticEl.style.display = "block";
                
                var fileInput = document.getElementById('importExcel');
                if (!fileInput.files.length) {
                    showStatus("Selecione um arquivo TXT primeiro");
                    logImportDiagnostic("Nenhum arquivo selecionado");
                    return;
                }
                
                var file = fileInput.files[0];
                var fileName = file.name.toLowerCase();
                
                if (!fileName.endsWith('.txt') && !fileName.endsWith('.csv')) {
                    showStatus("Por favor, selecione um arquivo TXT ou CSV para este método");
                    logImportDiagnostic("Arquivo inválido para importação simplificada: " + fileName);
                    return;
                }
                
                logImportDiagnostic("Iniciando importação simplificada de: " + file.name);
                
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        var content = e.target.result;
                        var lines = content.split(/\r?\n/);
                        var validLines = [];
                        
                        // Filtrar linhas vazias
                        for (var i = 0; i < lines.length; i++) {
                            var line = lines[i].trim();
                            if (line) {
                                if (fileName.endsWith('.csv')) {
                                    // Para CSV, pegamos apenas a primeira coluna
                                    var parts = line.split(',');
                                    if (parts.length > 0 && parts[0].trim()) {
                                        validLines.push(parts[0].trim());
                                    }
                                } else {
                                    // Para TXT, cada linha é uma espécie
                                    validLines.push(line);
                                }
                            }
                        }
                        
                        if (validLines.length === 0) {
                            throw new Error("Nenhuma espécie encontrada no arquivo");
                        }
                        
                        logImportDiagnostic("Espécies encontradas: " + validLines.length);
                        
                        // Adicionar espécies à lista
                        var addedCount = 0;
                        var duplicateCount = 0;
                        
                        for (var i = 0; i < validLines.length; i++) {
                            var speciesName = validLines[i];
                            
                            if (!speciesList.includes(speciesName)) {
                                speciesList.push(speciesName);
                                logImportDiagnostic("Espécie adicionada: " + speciesName);
                                addedCount++;
                            } else {
                                logImportDiagnostic("Espécie duplicada ignorada: " + speciesName);
                                duplicateCount++;
                            }
                        }
                        
                        // Salvar e atualizar a interface
                        window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                        updateSpeciesList();
                        populateSpeciesDropdowns();
                        
                        // Mostrar resultado
                        var message = "Importação concluída: " + addedCount + " espécies adicionadas";
                        if (duplicateCount > 0) {
                            message += ", " + duplicateCount + " duplicadas ignoradas";
                        }
                        
                        showStatus(message);
                        logImportDiagnostic("SUCESSO: " + message);
                        
                        // Limpar o campo de arquivo
                        fileInput.value = "";
                        
                    } catch (error) {
                        logImportDiagnostic("ERRO: " + error.message);
                        showStatus("ERRO ao processar arquivo: " + error.message);
                    }
                };
                
                reader.onerror = function() {
                    logImportDiagnostic("ERRO ao ler o arquivo");
                    showStatus("ERRO ao ler o arquivo");
                };
                
                reader.readAsText(file);
            });

            // Função para inicializar o autocomplete
            initAutocomplete();
        }

        // Carregar espécies do localStorage
        function loadSpecies() {
            try {
                var savedSpecies = window.localStorage.getItem("bioSpecies");
                if (savedSpecies) {
                    speciesList = JSON.parse(savedSpecies);
                } else {
                    // Espécies padrão se não houver nenhuma salva
                    speciesList = ["Espécie A", "Espécie B", "Espécie C"];
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                }
                updateSpeciesList();
            } catch (e) {
                console.error("Erro ao carregar espécies:", e);
                logDiagnostic("Erro ao carregar espécies: " + e.message);
            }
        }

        // Alternar exibição do gerenciador de espécies
        function toggleSpeciesManager() {
            if (speciesManagerEl.style.display === "block") {
                speciesManagerEl.style.display = "none";
                toggleSpeciesBtnEl.textContent = "Mostrar";
            } else {
                speciesManagerEl.style.display = "block";
                toggleSpeciesBtnEl.textContent = "Ocultar";
            }
        }

        // Adicionar nova espécie
        function addSpecies() {
            var newSpeciesName = newSpeciesEl.value.trim();
            
            if (!newSpeciesName) {
                showStatus("Digite um nome para a espécie");
                return;
            }
            
            if (speciesList.includes(newSpeciesName)) {
                showStatus("Esta espécie já existe");
                return;
            }
            
            speciesList.push(newSpeciesName);
            window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
            
            newSpeciesEl.value = "";
            updateSpeciesList();
            
            showStatus("Espécie adicionada com sucesso!");
        }

        // Remover espécie
        function removeSpecies(speciesName) {
            var index = speciesList.indexOf(speciesName);
            if (index !== -1) {
                if (confirm("Tem certeza que deseja remover a espécie '" + speciesName + "'?")) {
                    speciesList.splice(index, 1);
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                    updateSpeciesList();
                    showStatus("Espécie removida com sucesso!");
                }
            }
        }

        // Atualizar lista de espécies no gerenciador
        function updateSpeciesList() {
            if (!speciesListEl) {
                console.error("Elemento da lista de espécies não encontrado");
                return;
            }
            
            speciesListEl.innerHTML = "";
            
            if (speciesList.length === 0) {
                speciesListEl.innerHTML = "<p>Nenhuma espécie cadastrada</p>";
                return;
            }
            
            for (var i = 0; i < speciesList.length; i++) {
                var speciesName = speciesList[i];
                
                var div = document.createElement("div");
                div.className = "species-item";
                div.innerHTML = 
                    "<span>" + speciesName + "</span>" +
                    "<button class='red-btn delete-species-btn' data-species='" + speciesName + "'>Remover</button>";
                
                speciesListEl.appendChild(div);
            }
            
            // Adicionar eventos aos botões de remoção
            var deleteButtons = document.querySelectorAll('.delete-species-btn');
            deleteButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var speciesName = this.getAttribute('data-species');
                    removeSpecies(speciesName);
                });
            });
        }

        // Preencher dropdown de espécies
        function populateSpeciesDropdowns() {
            // Limpar dropdowns
            speciesSelectEl.innerHTML = "<option value=''>Selecione uma espécie</option>";
            document.getElementById('editSpeciesInput').innerHTML = "<option value=''>Selecione uma espécie</option>";
            
            // Preencher com espécies atualizadas
            speciesList.forEach(function(species) {
                var option = document.createElement("option");
                option.value = species;
                option.textContent = species;
                speciesSelectEl.appendChild(option);
                
                var editOption = option.cloneNode(true);
                document.getElementById('editSpeciesInput').appendChild(editOption);
            });
        }

        // Alternar exibição do Google Maps
        function toggleGoogleMaps() {
            if (mapsContainerEl.style.display === "block") {
                mapsContainerEl.style.display = "none";
            } else {
                mapsContainerEl.style.display = "block";
                mapsLatInputEl.value = "";
                mapsLngInputEl.value = "";
                
                // Fechar outros painéis de localização
                manualCoordsEl.style.display = "none";
                manualBtnEl.textContent = "Inserir Coordenadas Manualmente";
                locationHelpEl.style.display = "none";
            }
        }

        // Salvar coordenadas do Google Maps
        function saveMapsCoords() {
            var lat = parseFloat(mapsLatInputEl.value);
            var lng = parseFloat(mapsLngInputEl.value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showStatus("Digite valores válidos para latitude e longitude");
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showStatus("Coordenadas fora dos limites válidos");
                return;
            }
            
            currentLocation = {
                latitude: lat,
                longitude: lng,
                accuracy: 0, // Precisão desconhecida para coordenadas manuais
                timestamp: new Date().toISOString()
            };
            
            showStatus("Coordenadas do Google Maps salvas!");
            mapsContainerEl.style.display = "none";
        }

        // Mostrar mensagem de status
        function showStatus(message) {
            statusEl.style.display = "block";
            statusEl.innerText = message;
            setTimeout(function() {
                statusEl.style.display = "none";
            }, 3000);
        }
        
        // Registrar diagnóstico
        function logDiagnostic(message) {
            var now = new Date();
            var timestamp = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();
            diagnosticEl.innerHTML += timestamp + ' - ' + message + '<br>';
            diagnosticEl.style.display = "block";
            diagnosticEl.scrollTop = diagnosticEl.scrollHeight;
        }

        // Criar projeto
        function createProject() {
            var name = projectNameEl.value.trim();
            
            if (!name) {
                showStatus("Digite um nome para o projeto");
                return;
            }
            
            if (projects[name]) {
                showStatus("Este projeto já existe");
                return;
            }
            
            try {
                projects[name] = { data: [] };
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                projectNameEl.value = "";
                updateProjectList();
                
                // Selecionar o novo projeto
                projectSelectEl.value = name;
                currentProject = name;
                
                showStatus("Projeto criado: " + name);
            } catch (e) {
                showStatus("ERRO ao criar projeto: " + e.message);
            }
        }

        // Excluir projeto
        function deleteProject() {
            if (!currentProject) {
                showStatus("Selecione um projeto para excluir");
                return;
            }
            
            if (confirm("Tem certeza que deseja excluir o projeto '" + currentProject + "'?")) {
                delete projects[currentProject];
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                currentProject = null;
                updateProjectList();
                dataListEl.innerHTML = "";
                showStatus("Projeto excluído com sucesso!");
            }
        }

        // Atualizar lista de projetos
        function updateProjectList() {
            // Limpar lista
            projectSelectEl.innerHTML = "<option value=''>Selecione um projeto</option>";
            
            // Adicionar projetos
            for (var name in projects) {
                var option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                projectSelectEl.appendChild(option);
            }
        }

        // Carregar projeto selecionado
        function loadProject() {
            currentProject = projectSelectEl.value;
            if (currentProject) {
                showData();
                showStatus("Projeto carregado: " + currentProject);
            } else {
                dataListEl.innerHTML = "";
            }
        }
        
        // Método alternativo de localização
        function useAlternativeLocation() {
            logDiagnostic("Tentando método alternativo de geolocalização");
            
            // Interrompendo o watch atual se houver
            stopLocationWatch();
            
            locationBtnEl.disabled = true;
            locationBtnEl.textContent = "Capturando...";
            showStatus("Tentando método alternativo...");
            
            // Tentar uma abordagem diferente com menos precisão
            var options = {
                enableHighAccuracy: false,  // Menos precisão, maior chance de funcionar
                timeout: 10000,
                maximumAge: 60000  // Aceitar posições com até 1 minuto
            };
            
            if (!navigator.geolocation) {
                showStatus("Geolocalização não suportada");
                locationBtnEl.disabled = false;
                locationBtnEl.textContent = "Capturar Localização";
                toggleManualCoords();
                return;
            }
            
            try {
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        locationUpdateCount++;
                        
                        var accuracy = position.coords.accuracy;
                        logDiagnostic("Posição obtida #" + locationUpdateCount + " (precisão: " + Math.round(accuracy) + "m)");
                        
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Parar de observar após obter uma localização
                        stopLocationWatch();
                        
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        showStatus("Localização obtida! Precisão: " + Math.round(accuracy) + "m");
                    },
                    function(error) {
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        
                        logDiagnostic("Erro no método alternativo: " + error.code + " - " + error.message);
                        showStatus("Método alternativo falhou. Use entrada manual.");
                        toggleManualCoords();
                    },
                    options
                );
            } catch (e) {
                logDiagnostic("Exceção: " + e.message);
                locationBtnEl.disabled = false;
                locationBtnEl.textContent = "Capturar Localização";
                showStatus("Erro na geolocalização. Use entrada manual.");
                toggleManualCoords();
            }
        }

        // Capturar localização
        function captureLocation() {
            // Interrompendo o watch atual se houver
            stopLocationWatch();
            
            if (!navigator.geolocation) {
                showStatus("Seu navegador não suporta geolocalização");
                toggleManualCoords();
                return;
            }
            
            locationBtnEl.disabled = true;
            locationBtnEl.textContent = "Capturando...";
            showStatus("Obtendo sua localização...");
            logDiagnostic("Iniciando captura de localização");
            
            var options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            try {
                locationUpdateCount = 0;
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        locationUpdateCount++;
                        
                        var accuracy = position.coords.accuracy;
                        logDiagnostic("Posição obtida #" + locationUpdateCount + " (precisão: " + Math.round(accuracy) + "m)");
                        
                        // Se já temos uma localização e a precisão não é melhor, ignorar
                        if (currentLocation && accuracy >= currentLocation.accuracy) {
                            return;
                        }
                        
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Se a precisão for boa ou tivermos várias atualizações, parar
                        if (accuracy < 50 || locationUpdateCount > 5) {
                            stopLocationWatch();
                            locationBtnEl.disabled = false;
                            locationBtnEl.textContent = "Capturar Localização";
                            showStatus("Localização obtida! Precisão: " + Math.round(accuracy) + "m");
                        }
                    },
                    function(error) {
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        
                        logDiagnostic("Erro de geolocalização: " + error.code + " - " + error.message);
                        
                        // Código 1 = permissão negada
                        if (error.code === 1) {
                            showStatus("Permissão de localização negada");
                            locationHelpEl.style.display = "block";
                        } else if (error.code === 2) {
                            // Erro de disponibilidade - tente método alternativo
                            showStatus("Localização indisponível. Tentando alternativa...");
                            setTimeout(useAlternativeLocation, 1000);
                        } else {
                            showStatus("ERRO: " + error.message);
                            locationHelpEl.style.display = "block";
                        }
                    },
                    options
                );
            } catch (e) {
                logDiagnostic("Exceção: " + e.message);
                locationBtnEl.disabled = false;
                locationBtnEl.textContent = "Capturar Localização";
                showStatus("Erro na geolocalização. Use entrada manual.");
                toggleManualCoords();
            }
            
            // Tempo máximo para watch (30 segundos)
            setTimeout(function() {
                if (watchId !== null) {
                    logDiagnostic("Timeout da captura de localização");
                    if (currentLocation) {
                        // Usamos a melhor localização que conseguimos até agora
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        showStatus("Localização obtida (timeout)! Precisão: " + 
                                   Math.round(currentLocation.accuracy) + "m");
                    } else {
                        stopLocationWatch();
                        locationBtnEl.disabled = false;
                        locationBtnEl.textContent = "Capturar Localização";
                        showStatus("Tempo esgotado. Use entrada manual.");
                        toggleManualCoords();
                    }
                }
            }, 30000);
        }
        
        // Parar de observar localização
        function stopLocationWatch() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                logDiagnostic("Observação de localização interrompida");
            }
        }
        
        // Alternar modo de entrada manual de coordenadas
        function toggleManualCoords() {
            if (manualCoordsEl.style.display === "block") {
                manualCoordsEl.style.display = "none";
                manualBtnEl.textContent = "Inserir Coordenadas Manualmente";
            } else {
                manualCoordsEl.style.display = "block";
                manualBtnEl.textContent = "Ocultar Entrada Manual";
            }
        }
        
        // Salvar coordenadas inseridas manualmente
        function saveManualCoords() {
            var lat = parseFloat(latInputEl.value);
            var lng = parseFloat(lngInputEl.value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showStatus("Digite valores válidos para latitude e longitude");
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showStatus("Coordenadas fora dos limites válidos");
                return;
            }
            
            currentLocation = {
                latitude: lat,
                longitude: lng,
                accuracy: 0, // Precisão desconhecida para coordenadas manuais
                timestamp: new Date().toISOString()
            };
            
            showStatus("Coordenadas salvas manualmente!");
            manualCoordsEl.style.display = "none";
            manualBtnEl.textContent = "Inserir Coordenadas Manualmente";
        }

        // Salvar dados
        function saveData() {
            if (!currentProject) {
                showStatus("Selecione um projeto primeiro");
                return;
            }
            
            if (!currentLocation) {
                showStatus("Capture a localização ou insira manualmente");
                return;
            }
            
            var species = speciesInputEl.value.trim();
            var abundance = parseInt(abundanceEl.value);
            var notes = notesEl.value.trim();
            
            if (!species) {
                showStatus("Digite uma espécie");
                return;
            }
            
            // Verificar se a espécie existe na lista
            if (!speciesList.includes(species)) {
                if (confirm("A espécie '" + species + "' não está na lista. Deseja adicioná-la?")) {
                    speciesList.push(species);
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                    updateSpeciesList();
                } else {
                    return;
                }
            }
            
            if (isNaN(abundance) || abundance < 0) {
                showStatus("Digite uma abundância válida");
                return;
            }
            
            if (!notes) {
                showStatus("Digite uma observação");
                return;
            }
            
            try {
                var newData = {
                    species: species,
                    abundance: abundance,
                    latitude: currentLocation.latitude,
                    longitude: currentLocation.longitude,
                    accuracy: currentLocation.accuracy || 0,
                    timestamp: currentLocation.timestamp,
                    observation: notes,
                    manual: currentLocation.accuracy === 0
                };
                
                projects[currentProject].data.push(newData);
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                
                speciesInputEl.value = "";
                selectedSpecies = "";
                abundanceEl.value = "";
                notesEl.value = "";
                currentLocation = null;
                showData();
                showStatus("Dados salvos com sucesso!");
            } catch (e) {
                showStatus("ERRO ao salvar dados: " + e.message);
            }
        }

        // Mostrar dados
        function showData() {
            if (!currentProject) return;
            
            dataListEl.innerHTML = "";
            var data = projects[currentProject].data;
            
            if (data.length === 0) {
                dataListEl.innerHTML = "<p>Nenhum dado coletado</p>";
                return;
            }
            
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var date = new Date(item.timestamp);
                var isManual = item.manual ? " (Manual)" : "";
                var accuracyText = !item.manual && item.accuracy ? ` | Precisão: ${Math.round(item.accuracy)}m` : "";
                
                var div = document.createElement("div");
                div.className = "item";
                div.dataset.index = i;
                div.innerHTML = 
                    "<div class='coords'>Espécie: " + item.species + " | Abundância: " + item.abundance + "</div>" +
                    "<div class='coords'>Lat: " + item.latitude.toFixed(6) + 
                    " | Long: " + item.longitude.toFixed(6) + 
                    accuracyText + isManual + "</div>" +
                    "<div class='notes'>" + item.observation + "</div>" +
                    "<div class='coords'>" + date.toLocaleString() + "</div>" +
                    "<div class='action-buttons'>" +
                    "<button class='edit-btn orange-btn'>Editar</button>" +
                    "<button class='delete-btn red-btn'>Excluir</button>" +
                    "</div>";
                
                dataListEl.appendChild(div);
            }
            
            // Adicionar eventos de edição e exclusão
            var editButtons = document.querySelectorAll('.edit-btn');
            var deleteButtons = document.querySelectorAll('.delete-btn');
            
            editButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var itemDiv = this.parentNode.parentNode;
                    var index = parseInt(itemDiv.dataset.index);
                    openEditModal(index);
                });
            });
            
            deleteButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var itemDiv = this.parentNode.parentNode;
                    var index = parseInt(itemDiv.dataset.index);
                    deleteRecord(index);
                });
            });
        }
        
        // Abrir modal de edição
        function openEditModal(index) {
            var item = projects[currentProject].data[index];
            
            // Preencher o modal com os dados atuais
            document.getElementById('editSpeciesInput').value = item.species;
            document.getElementById('editAbundance').value = item.abundance;
            document.getElementById('editNotes').value = item.observation;
            document.getElementById('editLat').value = item.latitude;
            document.getElementById('editLng').value = item.longitude;
            
            // Armazenar o índice atual para uso posterior
            document.getElementById('editModal').dataset.currentIndex = index;
            
            // Mostrar o modal
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Salvar edições
        function saveEdit() {
            var index = parseInt(document.getElementById('editModal').dataset.currentIndex);
            var item = projects[currentProject].data[index];
            
            // Obter novos valores
            var newSpecies = document.getElementById('editSpeciesInput').value.trim();
            var newAbundance = parseInt(document.getElementById('editAbundance').value);
            var newObservation = document.getElementById('editNotes').value.trim();
            var newLat = parseFloat(document.getElementById('editLat').value);
            var newLng = parseFloat(document.getElementById('editLng').value);
            
            // Validar
            if (!newSpecies) {
                showStatus("Digite uma espécie");
                return;
            }
            
            // Verificar se a espécie existe na lista
            if (!speciesList.includes(newSpecies)) {
                if (confirm("A espécie '" + newSpecies + "' não está na lista. Deseja adicioná-la?")) {
                    speciesList.push(newSpecies);
                    window.localStorage.setItem("bioSpecies", JSON.stringify(speciesList));
                    updateSpeciesList();
                } else {
                    return;
                }
            }
            
            if (isNaN(newAbundance) || newAbundance < 0) {
                showStatus("Digite uma abundância válida");
                return;
            }
            
            if (!newObservation) {
                showStatus("A observação não pode estar vazia");
                return;
            }
            
            if (isNaN(newLat) || isNaN(newLng) || newLat < -90 || newLat > 90 || newLng < -180 || newLng > 180) {
                showStatus("Coordenadas inválidas");
                return;
            }
            
            // Atualizar o item
            item.species = newSpecies;
            item.abundance = newAbundance;
            item.observation = newObservation;
            item.latitude = newLat;
            item.longitude = newLng;
            
            // Se as coordenadas foram alteradas, marcar como editado manualmente
            if (newLat !== item.latitude || newLng !== item.longitude) {
                item.manual = true;
                item.accuracy = 0;
            }
            
            // Salvar no localStorage
            window.localStorage.setItem("bioProjects", JSON.stringify(projects));
            
            // Fechar o modal
            document.getElementById('editModal').style.display = 'none';
            
            // Atualizar a visualização
            showData();
            showStatus("Registro atualizado com sucesso!");
        }
        
        // Excluir registro
        function deleteRecord(index) {
            if (confirm("Tem certeza que deseja excluir este registro?")) {
                // Remover o item do array
                projects[currentProject].data.splice(index, 1);
                
                // Salvar no localStorage
                window.localStorage.setItem("bioProjects", JSON.stringify(projects));
                
                // Atualizar a visualização
                showData();
                showStatus("Registro excluído com sucesso!");
            }
        }

        // Exportar para Excel
        function exportExcel() {
            if (!currentProject) {
                showStatus("Selecione um projeto primeiro");
                return;
            }
            
            var data = projects[currentProject].data;
            if (data.length === 0) {
                showStatus("Nenhum dado para exportar");
                return;
            }
            
            try {
                // Verificar se a biblioteca SheetJS está disponível
                if (typeof XLSX === 'undefined') {
                    showStatus("Biblioteca XLSX não carregada. Tentando exportar CSV...");
                    exportCSV();
                    return;
                }
                
                // Preparar dados para Excel
                var excelData = [];
                
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var date = new Date(item.timestamp);
                    
                    excelData.push({
                        'Data/Hora': date.toLocaleString(),
                        'Espécie': item.species,
                        'Abundância': item.abundance,
                        'Latitude': item.latitude,
                        'Longitude': item.longitude,
                        'Precisão (m)': item.accuracy || 0,
                        'Método': item.manual ? "Manual" : "GPS",
                        'Observação': item.observation
                    });
                }
                
                // Criar um workbook
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.json_to_sheet(excelData);
                
                // Adicionar worksheet ao workbook
                XLSX.utils.book_append_sheet(wb, ws, "Dados");
                
                // Gerar arquivo e fazer download
                var filename = currentProject + "_dados_" + 
                               new Date().toISOString().split('T')[0] + ".xlsx";
                
                XLSX.writeFile(wb, filename);
                showStatus("Arquivo Excel exportado com sucesso!");
                
            } catch (e) {
                showStatus("ERRO ao exportar Excel: " + e.message + ". Tentando CSV...");
                logDiagnostic("Erro Excel: " + e.message);
                // Tentar exportação CSV como fallback
                setTimeout(exportCSV, 1000);
            }
        }
        
        // Exportar para CSV (fallback se Excel falhar)
        function exportCSV() {
            if (!currentProject) return;
            
            var data = projects[currentProject].data;
            if (data.length === 0) return;
            
            try {
                var csv = "Data/Hora,Espécie,Abundância,Latitude,Longitude,Precisão (m),Método,Observação\n";
                
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var date = new Date(item.timestamp).toLocaleString();
                    csv += date + "," + 
                           item.species + "," + 
                           item.abundance + "," + 
                           item.latitude + "," + 
                           item.longitude + "," + 
                           (item.accuracy || 0) + "," + 
                           (item.manual ? "Manual" : "GPS") + ",\"" + 
                           item.observation + "\"\n";
                }
                
                var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
                var link = document.createElement("a");
                var url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                link.setAttribute("download", currentProject + "_dados.csv");
                link.style.visibility = "hidden";
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus("Dados exportados como CSV (fallback)");
            } catch (e) {
                showStatus("ERRO na exportação de dados: " + e.message);
            }
        }

        // Verificar suporte à geolocalização
        function checkGeolocationSupport() {
            if (!navigator.geolocation) {
                logDiagnostic("Geolocalização não suportada neste navegador");
                showStatus("Seu navegador não suporta geolocalização");
                return false;
            }
            
            logDiagnostic("Geolocalização suportada");
            return true;
        }

        // Verificar se a biblioteca XLSX está disponível e carregá-la se necessário
        function checkAndLoadXLSX() {
            if (typeof XLSX === 'undefined') {
                console.log("Biblioteca XLSX não encontrada, tentando carregar...");
                
                var script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
                script.async = true;
                script.onload = function() {
                    console.log("Biblioteca XLSX carregada com sucesso!");
                    logDiagnostic("Biblioteca XLSX carregada com sucesso!");
                };
                script.onerror = function() {
                    console.error("Falha ao carregar biblioteca XLSX");
                    logDiagnostic("Falha ao carregar biblioteca XLSX");
                };
                
                document.head.appendChild(script);
            } else {
                console.log("Biblioteca XLSX já está disponível");
            }
        }

        // Chamar a função de verificação após o carregamento da página
        window.addEventListener('load', checkAndLoadXLSX);

        // Função para inicializar o autocomplete
        function initAutocomplete() {
            // Autocomplete para o formulário principal
            speciesInputEl.addEventListener('input', handleInput);
            speciesInputEl.addEventListener('focus', handleFocus);
            speciesInputEl.addEventListener('keydown', handleKeydown);

            // Autocomplete para o modal de edição
            var editSpeciesInputEl = document.getElementById('editSpeciesInput');
            var editSpeciesSuggestionsEl = document.getElementById('editSpeciesSuggestions');
            
            if (editSpeciesInputEl && editSpeciesSuggestionsEl) {
                editSpeciesInputEl.addEventListener('input', function(e) {
                    handleInput.call(this, e, editSpeciesSuggestionsEl);
                });
                
                editSpeciesInputEl.addEventListener('focus', function(e) {
                    handleFocus.call(this, e, editSpeciesSuggestionsEl);
                });
                
                editSpeciesInputEl.addEventListener('keydown', function(e) {
                    handleKeydown.call(this, e, editSpeciesSuggestionsEl);
                });
                
                // Fechar sugestões ao clicar fora
                document.addEventListener('click', function(e) {
                    if (!editSpeciesInputEl.contains(e.target) && !editSpeciesSuggestionsEl.contains(e.target)) {
                        editSpeciesSuggestionsEl.style.display = 'none';
                    }
                });
            }

            // Fechar sugestões ao clicar fora (formulário principal)
            document.addEventListener('click', function(e) {
                if (!speciesInputEl.contains(e.target) && !speciesSuggestionsEl.contains(e.target)) {
                    speciesSuggestionsEl.style.display = 'none';
                }
            });
        }

        // Função para lidar com input
        function handleInput(e, suggestionsEl = speciesSuggestionsEl) {
            const query = this.value.toLowerCase();
            if (query.length < 1) {
                suggestionsEl.style.display = 'none';
                return;
            }

            const suggestions = speciesList.filter(species => 
                species.toLowerCase().includes(query)
            );

            if (suggestions.length > 0) {
                showSuggestions(suggestions, query, suggestionsEl, this);
            } else {
                suggestionsEl.style.display = 'none';
            }
        }

        // Função para lidar com focus
        function handleFocus(e, suggestionsEl = speciesSuggestionsEl) {
            if (this.value.length > 0) {
                const query = this.value.toLowerCase();
                const suggestions = speciesList.filter(species => 
                    species.toLowerCase().includes(query)
                );
                if (suggestions.length > 0) {
                    showSuggestions(suggestions, query, suggestionsEl, this);
                }
            }
        }

        // Função para lidar com keydown
        function handleKeydown(e, suggestionsEl = speciesSuggestionsEl) {
            const suggestions = suggestionsEl.children;
            let selectedIndex = -1;

            for (let i = 0; i < suggestions.length; i++) {
                if (suggestions[i].classList.contains('selected')) {
                    selectedIndex = i;
                    break;
                }
            }

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (suggestionsEl.style.display === 'none') {
                        const query = this.value.toLowerCase();
                        const suggestions = speciesList.filter(species => 
                            species.toLowerCase().includes(query)
                        );
                        if (suggestions.length > 0) {
                            showSuggestions(suggestions, query, suggestionsEl, this);
                        }
                    } else {
                        if (selectedIndex < suggestions.length - 1) {
                            if (selectedIndex >= 0) {
                                suggestions[selectedIndex].classList.remove('selected');
                            }
                            suggestions[selectedIndex + 1].classList.add('selected');
                            suggestions[selectedIndex + 1].scrollIntoView({ block: 'nearest' });
                        }
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (selectedIndex > 0) {
                        suggestions[selectedIndex].classList.remove('selected');
                        suggestions[selectedIndex - 1].classList.add('selected');
                        suggestions[selectedIndex - 1].scrollIntoView({ block: 'nearest' });
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0) {
                        selectSpecies(suggestions[selectedIndex].textContent, this, suggestionsEl);
                    }
                    break;
                case 'Escape':
                    suggestionsEl.style.display = 'none';
                    break;
            }
        }

        // Função para mostrar sugestões
        function showSuggestions(suggestions, query, suggestionsEl = speciesSuggestionsEl, inputEl = speciesInputEl) {
            suggestionsEl.innerHTML = '';
            suggestions.forEach(species => {
                const div = document.createElement('div');
                div.className = 'species-suggestion';
                
                // Destacar parte do texto que corresponde à busca
                const index = species.toLowerCase().indexOf(query.toLowerCase());
                if (index >= 0) {
                    const before = species.substring(0, index);
                    const match = species.substring(index, index + query.length);
                    const after = species.substring(index + query.length);
                    div.innerHTML = before + '<span class="highlight">' + match + '</span>' + after;
                } else {
                    div.textContent = species;
                }

                div.addEventListener('click', function() {
                    selectSpecies(species, inputEl, suggestionsEl);
                });
                suggestionsEl.appendChild(div);
            });
            suggestionsEl.style.display = 'block';
        }

        // Função para selecionar uma espécie
        function selectSpecies(species, inputEl = speciesInputEl, suggestionsEl = speciesSuggestionsEl) {
            inputEl.value = species;
            if (inputEl === speciesInputEl) {
                selectedSpecies = species;
            }
            suggestionsEl.style.display = 'none';
        }

        // Função para alternar cards
        function toggleCard(cardId) {
            var content = document.getElementById(cardId);
            if (content.style.display === "block") {
                content.style.display = "none";
            } else {
                content.style.display = "block";
            }
        }

        // Iniciar após o carregamento
        window.onload = init;
    </script>
</body>
</html> 